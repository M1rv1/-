from ortools.sat.python import cp_model
from sqlite3 import *
import random
from openpyxl import Workbook
from itertools import product
from openpyxl.styles import Alignment, PatternFill, Font, Border, Side
from openpyxl.utils import get_column_letter

# --------------------------------------------
# 1. Входные данные 
# --------------------------------------------

teachers = (
    {
    "name": "Якушева Н.Ю.",#Любые 2 дня

     "exce": {
        "Пн": (1, 2, 3, 4, 5, 6, 7, 8, ), 
        "Вт": (1, 2, 3, 4, 5, 6, 7, 8, ), 
        "Ср": (), 
        "Чт": (1, 2, 3, 4, 5, 6, 7, 8, ), 
        "Пт": (1, 2, 3, 4, 5, 6, 7, 8, ), 
        "Сб": (1, 2, 3, 4, 5, 6, 7, 8, )
     },
     "prio": {
         "1": (),
         "2": ()
     },
     "trans_1": 0,
      "color": "FFD1DC"
    },

     {
    "name": "Строганова В.А.",#Любые 2 дня

     "exce": {
        "Пн": (1, 2, 3, 4, 5, 6, 7, 8, ), 
        "Вт": (1, 2, 3, 4, 5, 6, 7, 8, ), 
        "Ср": (1, 2, 3, 4, 5, 6, 7, 8,  ), 
        "Чт": (), 
        "Пт": (), 
        "Сб": (1, 2, 3, 4, 5, 6, 7, 8, )
     },
     "prio": {
         "1": (),
         "2": ()
     },
     "trans_1": 0,
      "color": "FFD1DC"
    },

    {"name": "Кан А.Я.",
     "exce": {
        "Пн": (1, 2, 4, 5, 6, 7, 8,), #!!!!!! 3 согл
        "Вт": (1, 6, 7, 8,), 
        "Ср": (1, 4, 5, 6, 7, 8,), #!!!!!! 3 согл
        "Чт": (1, 6, 7, 8,), 
        "Пт": (1, 3, 4, 5, 6, 7, 8,), 
        "Сб": (1, 2, 3, 4, 5, 6, 7, 8,)
     },
     "prio": {
         "1": (203, 205, 206, 209, 211, ),
         "2": ()
     },
     "trans_1": 0,
     "color": "EEE6A3"
    },

    {"name": "Гигиняк М.Ю.",
     "exce": {
        "Пн": (1, 2,), 
        "Вт": (), 
        "Ср": (), 
        "Чт": (),   
        "Пт": (), 
        "Сб": (1, 2, 3, 4, 5, 6, 7, 8,)
     },
     "prio": {
         "1": (),
         "2": ()
     },
     "trans_1": 0,

     "color": "EFA94A"
    },

    {"name": "Каретникова А.С.",
     "exce": {
        "Пн": (1, 2,), 
        "Вт": (), 
        "Ср": (), 
        "Чт": (), 
        "Пт": (), 
        "Сб": (1, 2, 3, 4, 5, 6, 7, 8, )
     },
     "prio": {
         "1": (105, 203, 205, 206, 211, 216, ),
         "2": (401, )
     },
     "trans_1": 0,

     "color": "EFA94A"
    },

    {"name": "Корнев В.А.",
     "exce": {
        "Пн": (1, 2, 3, 4, 5, 6, 7, 8, ), 
        "Вт": (1, 2, 3, 4, 5, 6, 7, ), 
        "Ср": (1, 2, 6, 7, 8, ), 
        "Чт": (1, 2, 3, ), #!!!!4
        "Пт": (1, 2, 3, 4, ), #!!!!5
        "Сб": (1, 2, 3, 4, 5, 6, 7, 8, )
     },
     "prio": {
         "1": (),
         "2": ()
     },
     "trans_1": 0,
     "color": "7FB5B5"
    },
    
    {"name": "Полякова А.А.",
     "exce": {
        "Пн": (1, 2,), 
        "Вт": (), 
        "Ср": (), 
        "Чт": (), 
        "Пт": (), 
        "Сб": ()
     },
     "prio": {
         "1": (),
         "2": ()
     },
     "trans_1": 0,
     "color": "7FB5B5"
    },

    {"name": "Шаповалова А.Н.",
     "exce": {
        "Пн": (1, 2,), 
        "Вт": (1, 2, ), 
        "Ср": (1, 2, ), 
        "Чт": (1, 2, ), 
        "Пт": (1, 2, ), 
        "Сб": (1, 2, 3, 4, 5, 6, 7, 8,)
     },
     "prio": {
         "1": (),
         "2": ()
     },
     "trans_1": 0,
     "color": "5D9B9B"
    }, 

    {"name": "Бреслав И.Л.", #в 4 дня
     "exce": {
        "Пн": (1, 2,), 
        "Вт": (1, ), 
        "Ср": (1, ), 
        "Чт": (1, ), 
        "Пт": (1, ), 
        "Сб": (1, 2, 3, 4, 5, 6, 7, 8,)
     },
     "prio": {
         "1": (),
         "2": ()
     },
     "trans_1": 0,
     "color": "E7ECFF"
    },

    {"name": "Молочников А.А.", #!!!!!!!!!
     "exce": {
        "Пн": (1, 2,), 
        "Вт": (), 
        "Ср": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Чт": (), 
        "Пт": (), 
        "Сб": ()
     },
     "prio": {
         "1": (),
         "2": ()
     },
     "trans_1": 0,
     "color": "77DD77"
    },

    {"name": "Наумова М.В.",
    #$$$$
    # "exce": {
    #     "Пн": (),
    #     "Вт": (), 
    #     "Ср": (), 
    #     "Чт": (), 
    #     "Пт": (), 
    #     "Сб": ()
    #  },
     "exce": {
        "Пн": (1, 2, ), 
        "Вт": (1, ), #!!!!2
        "Ср": (1, ), #!!!!2
        "Чт": (1, ), #!!!!2
        "Пт": (1, ), #!!!!2
        "Сб": (1, 2, 3, 4, 5, 6, 7, 8, )
     },
     "prio": {
         "1": (211, ),
         "2": (311, 407, )
     },
     "trans_1": 0,
     "color": "FF7514"
    },

    {"name": "Безвершенко С.М.",
     "exce": {
        "Пн": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Вт": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Ср": (), 
        "Чт": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Пт": (), 
        "Сб": (1, 2, 3, 4, 5, 6, 7, 8,)
     },
     "prio": {
         "1": (211, ),
         "2": (401, 407, )
     },
     "trans_1": 0,
      "color": "FF8C69"
    },

    {"name": "Ковлягин М.С.",
     "exce": {
        "Пн": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Вт": (), 
        "Ср": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Чт": (), 
        "Пт": (4, 5, 6, 7, ), #!!!! 123 согл
        "Сб": ()
     },
     "prio": {
         "1": (216, 222, ),
         "2": (201, 213, )
     },
     "trans_1": 0,
     "color": "FF9BAA"
    },

    {"name": "Пятибратова К.В.",
     "exce": {
        "Пн": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Вт": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Ср": (1, ), 
        "Чт": (), 
        "Пт": (), 
        "Сб": ()
     },
     "prio": {
         "1": (203, 206, 209, 211, ),
         "2": (201, )
     },
     "trans_1": 1,
     "color": "FFB28B"
    },

    {"name": "Козлова Н.А.",
     "exce": {
        "Пн": (1, 2, ), 
        "Вт": (), 
        "Ср": (), 
        "Чт": (), 
        "Пт": (), 
        "Сб": ()
     },
     "prio": {
         "1": (),
         "2": ()
     },
     "trans_1": 0,
     "color": "FCE883"
    },

    {"name": "Вовина П.А.",
     "exce": {
        "Пн": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Вт": (), 
        "Ср": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Чт": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Пт": (), 
        "Сб": (1, 2, 3, 4, 5, 6, 7, 8,)
     },
     "prio": {
         "1": (),
         "2": ()
     },
     "trans_1": 0,
      "color": "BEBD7F"
    },

    {"name": "Боярская И.А.",
     "exce": {
        "Пн": (1, 2, 3, 4, 5, 6, 7, 8,),
        "Вт": (), 
        "Ср": (), 
        "Чт": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Пт": (), 
        "Сб": (1, 2, 3, 4, 5, 6, 7, 8,)
     },
     "prio": {
         "1": (209, ),
         "2": (410, )
     },
     "trans_1": 0,
     "color": "C6DF90"
    },

    {"name": "Золотухина Е.Л.",
     "exce": {
        "Пн": (1, 2, 4, 5, 6, 7, 8,), 
        "Вт": (4, 5, 6, 7, 8,), 
        "Ср": (4, 5, 6, 7, 8,), 
        "Чт": (4, 5, 6, 7, 8,), 
        "Пт": (4, 5, 6, 7, 8,), 
        "Сб": (1, 2, 3, 4, 5, 6, 7, 8,)
     },
     "prio": {
         "1": (),
         "2": ()
     },
     "trans_1": 1,
     "color": "99FF99"
    },

    {"name": "Дементьева Т.С.", #Очень надо в два дня 
     "exce": {
        "Пн": (1, 2, 3, 4, 5, 6, 7, 8), 
        "Вт": (), 
        "Ср": (), 
        "Чт": (), 
        "Пт": (7, ), 
        "Сб": (7, )
     },
     "prio": {
         "1": (211, ),
         "2": (401, 407, )
     },
     "trans_1": 0,
     "color": "AFDAFC"
    },

    {"name": "Кулева Е.Ю.",
     "exce": {
        "Пн": (1, 2, ), 
        "Вт": (), 
        "Ср": (), 
        "Чт": (), 
        "Пт": (), 
        "Сб": ()
     },
     "prio": {
         "1": (),
         "2": ()
     },
     "trans_1": 0,
     "color": "E6E6FA"
    },

    {"name": "Петухова А.М.",
     "exce": {
        "Пн": (1, 2,), 
        "Вт": (), 
        "Ср": (), 
        "Чт": (), 
        "Пт": (), 
        "Сб": ()
     },
     "prio": {
         "1": (),
         "2": ()
     },
     "trans_1": 0,
     "color": "B5F2EA"
    },

    {"name": "Шебарина О.О.", #в 3 дня
     "exce": {
        "Пн": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Вт": (), 
        "Ср": (), 
        "Чт": (), 
        "Пт": (), 
        "Сб": (1, 2, 3, 4, 5, 6, 7, 8,)
     },
     "prio": {
         "1": (),
         "2": ()
     },
     "trans_1": 0,
      "color": "F5F5DC"
    },

    {"name": "Адамов В.К.",
     "exce": {
        "Пн": (1, 2, 3, 4, ), #!!!!!!!!!!!!!!!!!!!!!!!! 567 без согл
        "Вт": (6, 7, ), 
        "Ср": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Чт": (), 
        "Пт": (1, 2, 3, 4, ), #!!!!!!!!!!!!!!!!!!!!!!!! 567 без согл
        "Сб": (6, 7, 8,)
     },
     "prio": {
         "1": (203, 206, ),
         "2": (409, )
     },
     "trans_1": 0,
      "color": "E4717A"
    },

    {"name": "Зудинов Н.В.",
     "exce": {
        "Пн": (1, 2, ), 
        "Вт": (), 
        "Ср": (), 
        "Чт": (), 
        "Пт": (), 
        "Сб": ()
     },
     "prio": {
         "1": (),
         "2": ()
     },
     "trans_1": 0,
      "color": "B39F7A"
    },

    {"name": "Гущина Н.В.",
     "exce": {
        "Пн": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Вт": (), 
        "Ср": (), 
        "Чт": (), 
        "Пт": (), 
        "Сб": ()
     },
     "prio": {
         "1": (105, 203, 205, 206, 210, ),
         "2": (212, 213, 401, )
     },
     "trans_1": 0,
      "color": "E6D690"
    },

    {"name": "Эдлина Н.Ю.", #В 4 дня
     "exce": {
        "Пн": (1, 2,), 
        "Вт": (), 
        "Ср": (), 
        "Чт": (), 
        "Пт": (), 
        "Сб": (1, 2, 3, 4, 5, 6, 7, 8,)
     },
     "prio": {
         "1": (105, 203, 205, 206, 209, 210, 211, ),
         "2": ()
     },
     "trans_1": 0,
     "color": "EAE0C8"
    },

    {"name": "Пискарева О.Л.", #Максимальная лояльность 
     "exce": {
        "Пн": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Вт": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Ср": (), 
        "Чт": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Пт": (), 
        "Сб": (1, 2, 3, 4, 5, 6, 7, 8,)
     },
     "prio": {
         "1": (209, 210, 211, ),
         "2": (218, 408, 409, )
     },
     "trans_1": 0,
     "color": "F2E8C9"
    },

    {"name": "Бармасова Г.А.",
     "exce": {
        "Пн": (), 
        "Вт": (1, 2, 4, 5, 6, 7, 8,), #!!!! 23 согл
        "Ср": (), 
        "Чт": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Пт": (1, 4, 5, 6, 7, 8,), #!!!! 23 согл
        "Сб": ()
     },
     "prio": {
         "1": (105, 206, 209, ),
         "2": (309, 311, )
     },
     "trans_1": 0,
     "color": "F2DDC6"
     },

     {"name": "Бабушкин А.Д.",
     "exce": {
        "Пн": (1, 2,), 
        "Вт": (), 
        "Ср": (), 
        "Чт": (), 
        "Пт": (), 
        "Сб": ()
     },
     "prio": {
         "1": (),
         "2": ()
     },
     "trans_1": 0,
     "color": "FDF4E3"
    },

      {"name": "Размашкин В.Н.",
       
     "exce": {
        "Пн": (1, 2,), 
        "Вт": (1, 2, ), 
        "Ср": (1, 2,), 
        "Чт": (1, 2,), 
        "Пт": (1, 2,), 
        "Сб": (1, 2, 3, 4, 5, 6, 7, 8,)
     },
     
     "prio": {
         "1": (105, 206, 211, 222, ),
         "2": (201, 301, 401, )
     },
     "trans_1": 0,
     "color": "C6D8FF"
    },

     {"name": "Колосов И.М.",
     "exce": {
        "Пн": (1, 2, 4, 5, 6, 7, 8,), #!!!!!!!!!!!!!!!!!!!!!! 3
        "Вт": (4, 5, 6, 7, 8,), 
        "Ср": (4, 5, 6, 7, 8,), 
        "Чт": (4, 5, 6, 7, 8,), 
        "Пт": (4, 5, 6, 7, 8,), #!!!!!!!!!!!!!!!!!!!!!!!!!! 123
        "Сб": (1, 2, 3, 4, 5, 6, 7, 8, )
     },
     "prio": {
         "1": (),
         "2": ()
     },
     "trans_1": 0,
      "color": "3EB489"
    },

     {"name": "Лунин А.С.",
     "exce": {
        "Пн": (1, 2,), 
        "Вт": (1, 2, ), 
        "Ср": (1, 2, ), 
        "Чт": (1, 2, ), 
        "Пт": (1, 2, ), 
        "Сб": ()
     },
     "prio": {
         "1": (),
         "2": ()
     },
     "trans_1": 0,
      "color": "ACE5EE"
    },

     {"name": "Назаренко К.Б.",
     "exce": {
        "Пн": (1, 2,), 
        "Вт": (), 
        "Ср": (), 
        "Чт": (), 
        "Пт": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Сб": (1, 2, 3, 4, 5, 6, 7, 8,)
     },
     "prio": {
         "1": (201, 203, 211, ),
         "2": (408, 401, )
     },
     "trans_1": 0,
     "color": "A8E4A0"
    },


     {"name": "Быков Н.А.",
     "exce": {
        "Пн": (1, 2,), 
        "Вт": (), 
        "Ср": (), 
        "Чт": (), 
        "Пт": (), 
        "Сб": ()
     },
     "prio": {
         "1": (),
         "2": ()
     },
     "trans_1": 0,
     "color": "CCCCFF"
    },

     {"name": "Ганкевич В.Д.",
     "exce": {
        "Пн": (1, 2,), 
        "Вт": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Ср": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Чт": (), 
        "Пт": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Сб": ()
     }, 
     "prio": {
         "1": (203, 206, 209, ),
         "2": (309, 311)
     },
     "trans_1": 0,
      "color": "FAE7B5"
    },

     {"name": "Чеботарь Т.Ю.",
     "exce": {
        "Пн": (1, 2,), 
        "Вт": (), 
        "Ср": (), 
        "Чт": (), 
        "Пт": (), 
        "Сб": ()
     },
     "prio": {
         "1": (),
         "2": ()
     },
     "trans_1": 0,
     "color": "FADADD"
    },

     {"name": "Ковалева Г.В.",
     "exce": {
        "Пн": (1, 2,), 
        "Вт": (1, ), 
        "Ср": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Чт": (1, ), 
        "Пт": (1, ), 
        "Сб": (1, )
     },
     "prio": {
         "1": (205, 209, ),
         "2": (309, )
     },
     "trans_1": 0,
      "color": "AFEEEE"
    },

     {"name": "Офимкина П.А.",
     "exce": {
        "Пн": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Вт": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Ср": (1, ), 
        "Чт": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Пт": (), 
        "Сб": (1, 2, 3, 4, 5, 6, 7, 8,)
     },
     "prio": {
         "1": (105, 203, 205, 206, 209, 210, 211, ),
         "2": (201, 212, 213, 401, )
     },
     "trans_1": 0,
      "color": "ACB78E"
    },

     {"name": "Анухин П.М.",
     "exce": {
        "Пн": (1, 2,), 
        "Вт": (), 
        "Ср": (), 
        "Чт": (), 
        "Пт": (), 
        "Сб": ()
     }, 
     "prio": {
         "1": (),
         "2": ()
     },
     "trans_1": 0,
      "color": "DAD871"
    },

     {"name": "Гофман А.С.",
     "exce": {
        "Пн": (1, 2,), 
        "Вт": (), 
        "Ср": (), 
        "Чт": (), 
        "Пт": (), 
        "Сб": ()
     },
     "prio": {
         "1": (),
         "2": ()
     },
     "trans_1": 0,
      "color": "FFCF48"
    },

     {"name": "Бабушкина А.А.",
     "exce": {
        "Пн": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Вт": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Ср": (), # 1234567
        "Чт": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Пт": (), # 1234567
        "Сб": ()
     },
     "prio": {
         "1": (),
         "2": (212, )
     },
     "trans_1": 0,
       "color": "A2A2D0"
    },

     {"name": "Гайдукова Е.В.",
     "exce": {
        "Пн": (1, 2,), 
        "Вт": (), 
        "Ср": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Чт": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Пт": (), 
        "Сб": ()
     },
     "prio": {
         "1": (105, 209, 211, 216, ),
         "2": (212, 401, )
     },
     "trans_1": 0,
      "color": "FFC1CC"
    },

     {"name": "Ашик Е.В.",
     "exce": {
        "Пн": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Вт": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Ср": (), 
        "Чт": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Пт": (), 
        "Сб": (1, 2, 3, 4, 5, 6, 7, 8,)
     },
     "prio": {
         "1": (),
         "2": (206, )
     },
     "trans_1": 0,
      "color": "FCD975"
    },
    
     {"name": "Князева В.А.",
     "exce": {
        "Пн": (1, 2,), 
        "Вт": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Ср": ( ), #!!!!!!!!!!!! 1 согл
        "Чт": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Пт": (), #!!!!!!!!!!! 12 согл
        "Сб": (1, 2, 3, 4, 5, 6, 7, 8,)
     },
     "prio": {
         "1": (),
         "2": ()
     },
     "trans_1": 0,
      "color": "5F9EA0"
    },

     {"name": "Трубицын Н.Ф.",
     "exce": {
        "Пн": (1, 2,), 
        "Вт": (), 
        "Ср": (), 
        "Чт": (), 
        "Пт": (), 
        "Сб": ()
     },
     "prio": {
         "1": (),
         "2": ()
     },
     "trans_1": 0,
      "color": "FFBD88"
     },

     {"name": "Шерстнева Е.С.",
     "exce": {
        "Пн": (1, 2, 5, 6, 7, 8,), 
        "Вт": (5, 6, 7, 8,), 
        "Ср": (5, 6, 7, 8,), 
        "Чт": (5, 6, 7, 8,), 
        "Пт": (5, 6, 7, 8, ), 
        "Сб": ()
     },
     "prio": {
         "1": (206, 211, ),
         "2": ()
     },
     "trans_1": 0,
     "color": "9FE2BF"
    },

     {"name": "Булатова А.А.", 
     "exce": {
        "Пн": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Вт": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Ср": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Чт": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Пт": (1, 2, 3, 4, 5, 6, 7, 8,), 
        "Сб": () #Только 5 слотов может!!!!!
     },
     "prio": {
         "1": (209, 206, ),
         "2": (401, 408, )
     },
     "trans_1": 0,
     "color": "71BC78"
    },

     {"name": "Ильин С.Л.",
     "exce": {
        "Пн": (3, 4, 5, 6, 7, 8,), 
        "Вт": (1, ), 
        "Ср": (1, ), 
        "Чт": (1, ), 
        "Пт": (1, 2, ), 
        "Сб": (1, 2, 3, 4, 5, 6, 7, 8,)
     },
     "prio": {
         "1": (203, 211, ),
         "2": (301, )
     },
     "trans_1": 0,
     "color": "E5E4E2"
    },

     {"name": "Гарай Е.С.",
    
     "exce": {
        "Пн": (1, 2, 3, ), #!!!!!!4567 без согл
        "Вт": (1, 5, 6, 7, 8,), 
        "Ср": (1, 5, 6, 7, 8,), 
        "Чт": (1, 5, 6, 7, 8,), 
        "Пт": (1, 5, ), #!!!!!!67 без согл
        "Сб": (1, 2, 3, 4, 5, 6, 7, 8,)
     },
     "prio": {
         "1": (216, ),
         "2": (408, 409, )
     },
     "trans_1": 0,
      "color": "DCD0FF"
    },


    {"name": "Киселев А.С.",
     "exce": {
        "Пн": (1, 2, 3, ), #!!!!!!!!! 4 согл
        "Вт": (1, 2, 3, ), #!!!!!!!!! 4 согл
        "Ср": (1, 2, 3, ), #!!!!!!!!! 4 согл
        "Чт": (1, 2, 3, 4, ), 
        "Пт": (1, 2, 3, 4, ), 
        "Сб": (1, 2, 3, 4, 5, 6, 7, 8,)
     },
     "prio": {
         "1": (),
         "2": ()
     },
     "trans_1": 0,
      "color": "ACE1AF"
    },

    {"name": "Грязнова А.Д.",
     "exce": {
        "Пн": (1, 2,), 
        "Вт": (1, 2, ), 
        "Ср": (1, 2, ), 
        "Чт": (1, 2, ), 
        "Пт": (1, 2, 3, ), 
        "Сб": (1, 2, 3, 4, 5, 6, 7, 8,)
     },
     "prio": {
         "1": (206, 211, 216, ),
         "2": (212, 213, )
     },
     "trans_1": 0,
     "color": "D8BFD8"
    },

    {"name": "Черниговская Н.В.",
     "exce": {
        "Пн": (1, 2, 3, 4, 5, 6, 7, 8, ), 
        "Вт": (1, 2, 3, 4, 5, ), 
        "Ср": (), 
        "Чт": (1, 2, 3, 4, 5, ), 
        "Пт": (1, 2, 3, 4, 5, 6, 7, 8, ), 
        "Сб": ()
     },
     "prio": {
         "1": (),
         "2": ()
     },
     "trans_1": 0,
     "color": "FFBCAD"
    },

    {"name": "Скрипняк П.О.",#Любые 2 дня
    # "exce": {
    #     "Пн": (), #!!!! 2 согл
    #     "Вт": (), 
    #     "Ср": (), 
    #     "Чт": (), 
    #     "Пт": (), 
    #     "Сб": ()
    #  },

     "exce": {
        "Пн": (1, 2, 3, 4, 5, 6, 7, 8, ), 
        "Вт": (), 
        "Ср": (1, 2, 3, 4, 5, 6, 7, 8, ), 
        "Чт": (1, 2, 3, 4, 5, 6, 7, 8, ), 
        "Пт": (), 
        "Сб": (1, 2, 3, 4, 5, 6, 7, 8, )
     },
     "prio": {
         "1": (),
         "2": ()
     },
     "trans_1": 0,
      "color": "FFEFD5"
    },

   

    )


rooms = [
    {
        "name": "105",
        "building": "1",
        "prio": "Нет прио",
        "size": "Маленький"
    },

    {
        "name": "101",
        "building": "1",
        "prio": "Англ",
        "size": "Маленький"
    },

    {
        "name": "203",
        "building": "1",
        "prio": "Нет прио",
        "size": "Большой"
    },

    {
        "name": "205",
        "building": "1",
        "prio": "Нет прио",
        "size": "Большой"
    },

    {
        "name": "206",
        "building": "1",
        "prio": "Нет прио",
        "size": "Большой"
    },

    {
        "name": "209",
        "building": "1",
        "prio": "Нет прио",
        "size": "Большой"
    },

    {
        "name": "210",
        "building": "1",
        "prio": "Англ",
        "size": "Маленький"
    },
    

    {
        "name": "211",
        "building": "1",
        "prio": "Нет прио",
        "size": "Большой"
    },

    {
        "name": "216",
        "building": "1",
        "prio": "Нет прио",
        "size": "Большой"
    },

    {
        "name": "222",
        "building": "1",
        "prio": "Нет прио",
        "size": "Большой"
    },

    {
        "name": "УОО",
        "building": "1",
        "prio": "Физра",
        "size": "Большой"
    },

    {
        "name": "ОТ_2",
        "building": "1",
        "prio": "Инфа",
        "size": "Маленький"
    },

    {
        "name": "ОТ_1",
        "building": "1",
        "prio": "Инфа",
        "size": "Маленький"
    },




    {
        "name": "201",
        "building": "2",
        "prio": "Нет прио",
        "size": "Большой"
    },

    {
        "name": "212",
        "building": "2",
        "prio": "Нет прио",
        "size": "Большой"
    },

    {
        "name": "213",
        "building": "2",
        "prio": "Нет прио",
        "size": "Большой"
    },

    {
        "name": "301",
        "building": "2",
        "prio": "Физика",
        "size": "Большой"
    },

    {
        "name": "309",
        "building": "2",
        "prio": "Химия",
        "size": "Большой"
    },

    {
        "name": "310",
        "building": "2",
        "prio": "Биология",
        "size": "Большой"
    },

    {
        "name": "311",
        "building": "2",
        "prio": "Нет прио",
        "size": "Большой"
    },

    {
        "name": "401",
        "building": "2",
        "prio": "Инфа",
        "size": "Большой"
    },

    {
        "name": "407",
        "building": "2",
        "prio": "Инфа",
        "size": "Большой"
    },

    {
        "name": "408",
        "building": "2",
        "prio": "Нет прио",
        "size": "Большой"
    },

    {
        "name": "409",
        "building": "2",
        "prio": "Нет прио",
        "size": "Большой"
    },

    {
        "name": "410",
        "building": "2",
        "prio": "Нет прио",
        "size": "Большой"
    },

    {
        "name": "СЗ",
        "building": "2",
        "prio": "Физра",
        "size": "Большой"
    },
]

classes = [ 

        { 
            "name": "8А", 
 
            "buildings": { 
                "Пн": "2",  
                "Вт": "1",  
                "Ср": "2", 
                "Чт": "1",  
                "Пт": "2",  
                "Сб": "1" 
            }, 
 
            "subjects": [ 
                {"name": "Русский", "teacher": ('Бабушкина А.А.',), "hours": 3}, 
                {"name": "Литра", "teacher": ('Гайдукова Е.В.',), "hours": 3}, 
                {"name": "Англ", "teacher": ('Бреслав И.Л.', 'Пискарева О.Л.',), "hours": 3}, 
                {"name": "Алгебра/Геометрия/Теор вер", "teacher": ('Киселев А.С.',), "hours": 8}, 
                {"name": "Инфа", "teacher": ('Безвершенко С.М.',), "hours": 1}, 
                {"name": "История", "teacher": ('Строганова В.А.',), "hours": 2}, 
                {"name": "Общество/Музыка", "teacher": ('Пятибратова К.В.',), "hours": 3}, 
                {"name": "География", "teacher": ('Козлова Н.А.',), "hours": 2}, 
                {"name": "Физика", "teacher": ('Вовина П.А.',), "hours": 4}, 
                {"name": "Химия", "teacher": ('Скрипняк П.О.',), "hours": 3}, 
                {"name": "Биология", "teacher": ('Золотухина Е.Л.',), "hours": 3}, 
                {"name": "Труд", "teacher": ('Дементьева Т.С.',), "hours": 1}, 
                {"name": "ОБЗР", "teacher": ('Кулева Е.Ю.',), "hours": 1}, 
                {"name": "Физра", "teacher": ('Чеботарь Т.Ю.',), "hours": 3},
 
            ] 
        }, 

        { 
            "name": "8Б", 
 
            "buildings": { 
                "Пн": "2",  
                "Вт": "1",  
                "Ср": "2", 
                "Чт": "1",  
                "Пт": "2",  
                "Сб": "1" 
            }, 
 
            "subjects": [ 
                {"name": "Русский/Литра", "teacher": ('Шерстнева Е.С.',), "hours": 6}, 
                {"name": "Англ", "teacher": ('Бреслав И.Л.', "Гигиняк М.Ю.", ), "hours": 3}, 
                {"name": "Алгебра/Геометрия", "teacher": ('Корнев В.А.',), "hours": 7}, 
                {"name": "Теор вер", "teacher": ('Киселев А.С.',), "hours": 1}, 
                {"name": "Инфа", "teacher": ('Безвершенко С.М.',), "hours": 1}, 
                {"name": "История", "teacher": ('Строганова В.А.',), "hours": 2}, 
                {"name": "Общество/Музыка", "teacher": ('Пятибратова К.В.',), "hours": 3}, 
                {"name": "География", "teacher": ('Козлова Н.А.',), "hours": 2}, 
                {"name": "Физика", "teacher": ('Вовина П.А.',), "hours": 4}, 
                {"name": "Химия", "teacher": ('Скрипняк П.О.',), "hours": 3}, 
                {"name": "Биология", "teacher": ('Ганкевич В.Д.',), "hours": 3}, 
                {"name": "Труд", "teacher": ('Дементьева Т.С.',), "hours": 1}, 
                {"name": "ОБЗР", "teacher": ('Кулева Е.Ю.',), "hours": 1}, 
                {"name": "Физра", "teacher": ('Чеботарь Т.Ю.',), "hours": 3},
 
            ] 
        }, 

    

        { 
            "name": "8В", 
 
            "buildings": { 
                "Пн": "2",  
                "Вт": "1",  
                "Ср": "2", 
                "Чт": "1",  
                "Пт": "2",  
                "Сб": "1" 
            }, 
 
            "subjects": [ 
                {"name": "Русский", "teacher": ('Бабушкина А.А.',), "hours": 3}, 
                {"name": "Литра", "teacher": ('Бабушкин А.Д.',), "hours": 3}, 
                {"name": "Англ", "teacher": ('Бреслав И.Л.', "Гигиняк М.Ю.",), "hours": 3}, 
                {"name": "Алгебра/Геометрия", "teacher": ('Черниговская Н.В.',), "hours": 7},  
                {"name": "Теор вер", "teacher": ('Киселев А.С.',), "hours": 1}, 
                {"name": "Инфа", "teacher": ('Безвершенко С.М.',), "hours": 1}, 
                {"name": "История", "teacher": ('Строганова В.А.',), "hours": 2}, 
                {"name": "Общество/Музыка", "teacher": ('Пятибратова К.В.',), "hours": 3}, 
                {"name": "География", "teacher": ('Козлова Н.А.',), "hours": 2}, 
                {"name": "Физика", "teacher": ('Вовина П.А.',), "hours": 4}, 
                {"name": "Химия", "teacher": ('Скрипняк П.О.',), "hours": 3}, 
                {"name": "Биология", "teacher": ('Бармасова Г.А.',), "hours": 3}, 
                {"name": "Труд", "teacher": ('Дементьева Т.С.',), "hours": 1}, 
                {"name": "ОБЗР", "teacher": ('Кулева Е.Ю.',), "hours": 1}, 
                {"name": "Физра", "teacher": ('Чеботарь Т.Ю.',), "hours": 3}, 
 
            ] 
        },  
 
# # #-------------------------------------------------------------------------------------------------------- 
 
    { 
        "name": "9А", 
 
        "buildings": { 
            "Пн": "1",  
            "Вт": "2",  
            "Ср": "1", 
            "Чт": "2",  
            "Пт": "1",  
            "Сб": "2" 
        }, 
 
        "subjects": [ 
            {"name": "Русский", "teacher": ('Каретникова А.С.',), "hours": 3}, 
            {"name": "Литра", "teacher": ('Полякова А.А.',), "hours": 4}, 
            {"name": "Англ", "teacher": ('Шаповалова А.Н.', 'Бреслав И.Л.', ), "hours": 3}, 
            {"name": "Алгебра/Геометрия", "teacher": ('Молочников А.А.',), "hours": 7}, 
            {"name": "Теор вер", "teacher": ('Наумова М.В.',), "hours": 1}, 
            {"name": "Инфа", "teacher": ('Безвершенко С.М.', 'Лунин А.С.',), "hours": 1}, 
            {"name": "История", "teacher": ('Ковлягин М.С.',), "hours": 2}, 
            {"name": "Общество", "teacher": ('Пятибратова К.В.',), "hours": 2}, 
            {"name": "География/Труд", "teacher": ('Дементьева Т.С.',), "hours": 3}, 
            {"name": "Физика", "teacher": ('Ильин С.Л.',), "hours": 3}, 
            {"name": "Химия", "teacher": ('Боярская И.А.',), "hours": 3}, 
            {"name": "Биология", "teacher": ('Золотухина Е.Л.',), "hours": 3}, 
            {"name": "ОБЗР", "teacher": ('Кулева Е.Ю.',), "hours": 1}, 
            {"name": "Физра", "teacher": ('Петухова А.М.',), "hours": 3}, 
 
        ] 
    }, 

    { 
        "name": "9Б", 
 
        "buildings": { 
            "Пн": "1",  
            "Вт": "2",  
            "Ср": "1", 
            "Чт": "2",  
            "Пт": "1",  
            "Сб": "2" 
        },  
 
        "subjects": [ 
            {"name": "Русский", "teacher": ('Каретникова А.С.',), "hours": 3}, 
            {"name": "Литра", "teacher": ('Бабушкин А.Д.',), "hours": 4}, 
            {"name": "Англ", "teacher": ('Шаповалова А.Н.', 'Шебарина О.О.', ), "hours": 3}, 
            {"name": "Геометрия", "teacher": ('Адамов В.К.',), "hours": 3}, 
            {"name": "Алгебра/Теор вер", "teacher": ('Наумова М.В.',), "hours": 5}, 
            {"name": "Инфа", "teacher": ('Безвершенко С.М.', 'Лунин А.С.',), "hours": 1}, 
            {"name": "История", "teacher": ('Ковлягин М.С.',), "hours": 2}, 
            {"name": "Общество", "teacher": ('Пятибратова К.В.',), "hours": 2}, 
            {"name": "География/Труд", "teacher": ('Дементьева Т.С.',), "hours": 3},
            {"name": "Физика", "teacher": ('Ильин С.Л.',), "hours": 3}, 
            {"name": "Химия", "teacher": ('Боярская И.А.',), "hours": 3}, 
            {"name": "Биология", "teacher": ('Золотухина Е.Л.',), "hours": 3}, 
            {"name": "ОБЗР", "teacher": ('Кулева Е.Ю.',), "hours": 1}, 
            {"name": "Физра", "teacher": ('Петухова А.М.',), "hours": 3}, 
 
        ] 
    }, 
 
    { 
        "name": "9В", 
 
        "buildings": { 
            "Пн": "1",  
            "Вт": "2",  
            "Ср": "1", 
            "Чт": "2",  
            "Пт": "1",  
            "Сб": "2" 
        },  
 
        "subjects": [ 
            {"name": "Русский/Литра", "teacher": ('Гущина Н.В.',), "hours": 7}, 
            {"name": "Англ", "teacher": ('Эдлина Н.Ю.', 'Бреслав И.Л.', ), "hours": 3}, 
            {"name": "Алгебра/Геометрия/Теор вер", "teacher": ('Наумова М.В.',), "hours": 8}, 
            {"name": "Инфа", "teacher": ('Безвершенко С.М.', 'Лунин А.С.',), "hours": 1}, 
            {"name": "История", "teacher": ('Ковлягин М.С.',), "hours": 2}, 
            {"name": "Общество", "teacher": ('Пятибратова К.В.',), "hours": 2}, 
            {"name": "География/Труд", "teacher": ('Дементьева Т.С.',), "hours": 3}, 
            {"name": "Физика", "teacher": ('Ильин С.Л.',), "hours": 3}, 
            {"name": "Химия", "teacher": ('Боярская И.А.',), "hours": 3}, 
            {"name": "Биология", "teacher": ('Бармасова Г.А.',), "hours": 3}, 
            {"name": "ОБЗР", "teacher": ('Зудинов Н.В.',), "hours": 1}, 
            {"name": "Физра", "teacher": ('Петухова А.М.',), "hours": 3}, 
 
        ] 
    },  


 
# # # # #-------------------------------------------------------------------------------------------------------- 
 
    { 
        "name": "10А", 
 
        "buildings": { 
            "Пн": "2",  
            "Вт": "1",  
            "Ср": "2", 
            "Чт": "1",  
            "Пт": "2",  
            "Сб": "1" 
        }, 

        "subjects": [ 
            {"name": "Литра", "teacher": ('Бабушкин А.Д.',), "hours": 4}, 
            {"name": "Русский", "teacher": ('Бабушкина А.А.',), "hours": 3}, 
            {"name": "Англ", "teacher": ('Эдлина Н.Ю.', 'Шаповалова А.Н.', ), "hours": 3}, 
            {"name": "История", "teacher": ('Назаренко К.Б.',), "hours": 3}, 
            {"name": "Общество", "teacher": ('Пятибратова К.В.',), "hours": 1}, 
            {"name": "География", "teacher": ('Грязнова А.Д.',), "hours": 1}, 
            {"name": "Алгебра/Геометрия", "teacher": ('Адамов В.К.',), "hours": 7}, 
            {"name": "Теор вер", "teacher": ('Размашкин В.Н.',), "hours": 1}, 
            {"name": "Инфа", "teacher": ('Колосов И.М.', 'Лунин А.С.',), "hours": 1}, 
            {"name": "Биология", "teacher": ('Бармасова Г.А.',), "hours": 2}, 
            {"name": "Химия/ИП", "teacher": ('Ганкевич В.Д.',), "hours": 4}, 
            {"name": "Физика", "teacher": ('Быков Н.А.',), "hours": 5}, 
            {"name": "Физра", "teacher": ('Чеботарь Т.Ю.', 'Петухова А.М.',), "hours": 3}, 
            {"name": "ОБЗР", "teacher": ('Кулева Е.Ю.',), "hours": 1}, 
        ] 
    }, 
 
    { 
        "name": "10Б", 
 
        "buildings": { 
            "Пн": "2",  
            "Вт": "1",  
            "Ср": "2", 
            "Чт": "1",  
            "Пт": "2",  
            "Сб": "1" 
        }, 
 
        "subjects": [ 
            {"name": "Литра/Русский", "teacher": ('Гущина Н.В.',), "hours": 7}, 
            {"name": "Англ", "teacher": ('Бреслав И.Л.', 'Шебарина О.О.', ), "hours": 3}, 
            {"name": "История", "teacher": ('Назаренко К.Б.',), "hours": 3}, 
            {"name": "Общество", "teacher": ('Пятибратова К.В.',), "hours": 1}, 
            {"name": "География", "teacher": ('Грязнова А.Д.',), "hours": 1}, 
            {"name": "Алгебра/Геометрия/Теор вер/ИП", "teacher": ('Размашкин В.Н.',), "hours": 9}, 
            {"name": "Инфа", "teacher": ('Колосов И.М.', 'Лунин А.С.',), "hours": 1}, 
            {"name": "Биология", "teacher": ('Бармасова Г.А.',), "hours": 2}, 
            {"name": "Химия", "teacher": ('Ковалева Г.В.',), "hours": 3}, 
            {"name": "Физика", "teacher": ('Быков Н.А.',), "hours": 5}, 
            {"name": "Физра", "teacher": ('Чеботарь Т.Ю.', 'Петухова А.М.',), "hours": 3}, 
            {"name": "ОБЗР", "teacher": ('Кулева Е.Ю.',), "hours": 1}, 
        ] 
    }, 
 
    { 
        "name": "10В", 
 
        "buildings": { 
            "Пн": "2",  
            "Вт": "1",  
            "Ср": "2", 
            "Чт": "1",  
            "Пт": "2",  
            "Сб": "1" 
        }, 
 
        "subjects": [ 
            {"name": "Русский", "teacher": ('Гайдукова Е.В.',), "hours": 3}, 
            {"name": "Литра", "teacher": ('Бабушкин А.Д.',), "hours": 4}, 
            {"name": "Англ", "teacher": ('Шаповалова А.Н.', 'Шебарина О.О.', ), "hours": 3}, 
            {"name": "История", "teacher": ('Назаренко К.Б.',), "hours": 3}, 
            {"name": "Общество", "teacher": ('Пятибратова К.В.',), "hours": 1}, 
            {"name": "География", "teacher": ('Грязнова А.Д.',), "hours": 1}, 
            {"name": "Алгебра/Геометрия", "teacher": ('Адамов В.К.',), "hours": 7}, 
            {"name": "Теор вер", "teacher": ('Размашкин В.Н.',), "hours": 1}, 
            {"name": "Инфа", "teacher": ('Колосов И.М.', 'Лунин А.С.',), "hours": 1}, 
            {"name": "Биология", "teacher": ('Бармасова Г.А.',), "hours": 2}, 
            {"name": "Химия", "teacher": ('Ковалева Г.В.',), "hours": 3}, 
            {"name": "Физика", "teacher": ('Быков Н.А.',), "hours": 5}, 
            {"name": "Физра", "teacher": ('Чеботарь Т.Ю.', 'Петухова А.М.',), "hours": 3}, 
            {"name": "ОБЗР", "teacher": ('Кулева Е.Ю.',), "hours": 1}, 
            {"name": "ИП", "teacher": ('Бабушкина А.А.',), "hours": 1},
        ] 
    }, 
 
    { 
        "name": "10Г", 
 
        "buildings": { 
            "Пн": "2",  
            "Вт": "1",  
            "Ср": "2", 
            "Чт": "1",  
            "Пт": "2",  
            "Сб": "1" 
        }, 
 
        "subjects": [ 
            {"name": "Русский", "teacher": ('Офимкина П.А.',), "hours": 3}, 
            {"name": "Литра/ИП", "teacher": ('Бабушкина А.А.',), "hours": 5}, 
            {"name": "Англ", "teacher": ('Пискарева О.Л.', 'Шаповалова А.Н.', ), "hours": 3}, 
            {"name": "История", "teacher": ('Строганова В.А.',), "hours": 3}, 
            {"name": "Общество", "teacher": ('Пятибратова К.В.',), "hours": 1}, 
            {"name": "География", "teacher": ('Грязнова А.Д.',), "hours": 1}, 
            {"name": "Алгебра/Геометрия", "teacher": ('Гарай Е.С.',), "hours": 7}, 
            {"name": "Теор вер", "teacher": ('Размашкин В.Н.',), "hours": 1}, 
            {"name": "Инфа", "teacher": ('Колосов И.М.', 'Лунин А.С.',), "hours": 1}, 
            {"name": "Биология", "teacher": ('Бармасова Г.А.',), "hours": 2}, 
            {"name": "Химия", "teacher": ('Ганкевич В.Д.',), "hours": 3}, 
            {"name": "Физика", "teacher": ('Ильин С.Л.',), "hours": 5}, 
            {"name": "Физра", "teacher": ('Чеботарь Т.Ю.', 'Петухова А.М.',), "hours": 3}, 
            {"name": "ОБЗР", "teacher": ('Зудинов Н.В.',), "hours": 1}, 
        ] 
    }, 
 
# # # # # #-------------------------------------------------------------------------------------------------------- 
 
    { 
            "name": "11А", 
 
            "buildings": { 
                "Пн": "1",  
                "Вт": "2",  
                "Ср": "1", 
                "Чт": "2",  
                "Пт": "1",  
                "Сб": "2" 
            }, 
 
            "subjects": [ 
                {"name": "Русский", "teacher": ('Офимкина П.А.',), "hours": 3}, 
                {"name": "Литра", "teacher": ('Бабушкин А.Д.',), "hours": 3}, 
                {"name": "Англ", "teacher": ('Эдлина Н.Ю.', 'Шаповалова А.Н.',), "hours": 3},             
                {"name": "История", "teacher": ('Ковлягин М.С.',), "hours": 3}, 
                {"name": "Общество", "teacher": ('Пятибратова К.В.',), "hours": 1}, 
                {"name": "Право", "teacher": ('Булатова А.А.',), "hours": 1}, 
                {"name": "География", "teacher": ('Кан А.Я.',), "hours": 1}, 
                {"name": "Алгебра/Геометрия", "teacher": ('Наумова М.В.',), "hours": 7}, 
                {"name": "Теор вер", "teacher": ('Размашкин В.Н.',), "hours": 1}, 
                {"name": "Инфа", "teacher": ('Наумова М.В.', 'Колосов И.М.', ), "hours": 1}, 
                {"name": "Физика", "teacher": ('Анухин П.М.',), "hours": 5}, 
                {"name": "Химия", "teacher": ('Ковалева Г.В.',), "hours": 3}, 
                {"name": "Биология", "teacher": ('Ганкевич В.Д.',), "hours": 2}, 
                {"name": "ОБЗР", "teacher": ('Кулева Е.Ю.',), "hours": 1}, 
                {"name": "Физра", "teacher": ('Гофман А.С.', 'Петухова А.М.',), "hours": 2}, 
            ] 
        }, 
 
    { 
            "name": "11Б", 
 
            "buildings": { 
                "Пн": "1",  
                "Вт": "2",  
                "Ср": "1", 
                "Чт": "2",  
                "Пт": "1",  
                "Сб": "2" 
            }, 
 
            "subjects": [ 
                {"name": "Русский", "teacher": ('Каретникова А.С.',), "hours": 3}, 
                {"name": "Литра", "teacher": ('Полякова А.А.',), "hours": 3}, 
                {"name": "Англ", "teacher": ('Эдлина Н.Ю.', 'Шаповалова А.Н.',), "hours": 3},             
                {"name": "История", "teacher": ('Ковлягин М.С.',), "hours": 3}, 
                {"name": "Общество", "teacher": ('Пятибратова К.В.',), "hours": 1}, 
                {"name": "Право", "teacher": ('Булатова А.А.',), "hours": 1}, 
                {"name": "География", "teacher": ('Кан А.Я.',), "hours": 1}, 
                {"name": "Алгебра/Геометрия/Теорвер", "teacher": ('Размашкин В.Н.',), "hours": 8}, 
                {"name": "Инфа", "teacher": ('Наумова М.В.', 'Колосов И.М.', ), "hours": 1}, 
                {"name": "Физика", "teacher": ('Князева В.А.',), "hours": 5}, 
                {"name": "Химия", "teacher": ('Ковалева Г.В.',), "hours": 3}, 
                {"name": "Биология", "teacher": ('Ганкевич В.Д.',), "hours": 2}, 
                {"name": "ОБЗР", "teacher": ('Кулева Е.Ю.',), "hours": 1}, 
                {"name": "Физра", "teacher": ('Гофман А.С.', 'Петухова А.М.',), "hours": 2}, 
            ] 
        }, 

        { 
            "name": "11В", 
 
            "buildings": { 
                "Пн": "1",  
                "Вт": "2",  
                "Ср": "1", 
                "Чт": "2",  
                "Пт": "1",  
                "Сб": "2" 
            }, 
 
            "subjects": [ 
                {"name": "Русский/Литра", "teacher": ('Гущина Н.В.',), "hours": 6}, 
                {"name": "Англ", "teacher": ('Пискарева О.Л.', 'Шебарина О.О.',), "hours": 3},             
                {"name": "История", "teacher": ('Ковлягин М.С.',), "hours": 3}, 
                {"name": "Общество", "teacher": ('Пятибратова К.В.',), "hours": 1}, 
                {"name": "Право", "teacher": ('Булатова А.А.',), "hours": 1}, 
                {"name": "География", "teacher": ('Кан А.Я.',), "hours": 1}, 
                {"name": "Алгебра/Геометрия", "teacher": ('Гарай Е.С.',), "hours": 7},
                {"name": "Теорвер", "teacher": ('Размашкин В.Н.',), "hours": 1},
                {"name": "Инфа", "teacher": ('Наумова М.В.', 'Колосов И.М.', ), "hours": 1}, 
                {"name": "Физика", "teacher": ('Анухин П.М.',), "hours": 5}, 
                {"name": "Химия", "teacher": ('Ковалева Г.В.',), "hours": 3}, 
                {"name": "Биология", "teacher": ('Золотухина Е.Л.',), "hours": 2}, 
                {"name": "ОБЗР", "teacher": ('Кулева Е.Ю.',), "hours": 1}, 
                {"name": "Физра", "teacher": ('Гофман А.С.', 'Петухова А.М.',), "hours": 2}, 
            ] 
        }, 
    { 
            "name": "11Г", 
 
            "buildings": { 
                "Пн": "1",  
                "Вт": "2",  
                "Ср": "1", 
                "Чт": "2",  
                "Пт": "1",  
                "Сб": "2" 
            }, 
 
            "subjects": [ 
                {"name": "Русский/Литра", "teacher": ('Гайдукова Е.В.',), "hours": 6}, 
                {"name": "Англ", "teacher": ('Эдлина Н.Ю.', 'Шебарина О.О.',), "hours": 3},             
                {"name": "История", "teacher": ('Ковлягин М.С.',), "hours": 3}, 
                {"name": "Общество", "teacher": ('Пятибратова К.В.',), "hours": 1}, 
                {"name": "Право", "teacher": ('Булатова А.А.',), "hours": 1}, 
                {"name": "География", "teacher": ('Кан А.Я.',), "hours": 1}, 
                {"name": "Алгебра/Геометрия", "teacher": ('Молочников А.А.',), "hours": 7},
                {"name": "Теорвер", "teacher": ('Наумова М.В.',), "hours": 1},
                {"name": "Инфа", "teacher": ('Наумова М.В.', 'Колосов И.М.', ), "hours": 1}, 
                {"name": "Физика", "teacher": ('Князева В.А.',), "hours": 5}, 
                {"name": "Химия", "teacher": ('Боярская И.А.',), "hours": 3}, 
                {"name": "Биология", "teacher": ('Ашик Е.В.',), "hours": 2}, 
                {"name": "ОБЗР", "teacher": ('Зудинов Н.В.',), "hours": 1}, 
                {"name": "Физра", "teacher": ('Гофман А.С.', 'Петухова А.М.',), "hours": 2}, 
            ] 
        }, 
 
{ 
            "name": "11Д", 
 
            "buildings": { 
                "Пн": "1",  
                "Вт": "2",  
                "Ср": "1", 
                "Чт": "2",  
                "Пт": "1",  
                "Сб": "2" 
            }, 
 
            "subjects": [ 
                {"name": "Литра", "teacher": ('Гайдукова Е.В.',), "hours": 3},
                {"name": "Русский", "teacher": ('Каретникова А.С.',), "hours": 3},  
                {"name": "Англ", "teacher": ('Эдлина Н.Ю.', 'Шебарина О.О.',), "hours": 3},             
                {"name": "История", "teacher": ('Ковлягин М.С.',), "hours": 3}, 
                {"name": "Общество", "teacher": ('Пятибратова К.В.',), "hours": 1}, 
                {"name": "Право", "teacher": ('Булатова А.А.',), "hours": 1}, 
                {"name": "География", "teacher": ('Якушева Н.Ю.',), "hours": 1}, 
                {"name": "Алгебра/Геометрия", "teacher": ('Молочников А.А.',), "hours": 7},
                {"name": "Теорвер", "teacher": ('Размашкин В.Н.',), "hours": 1},
                {"name": "Инфа", "teacher": ('Наумова М.В.', 'Колосов И.М.', ), "hours": 1}, 
                {"name": "Физика", "teacher": ('Трубицын Н.Ф.',), "hours": 5}, 
                {"name": "Химия", "teacher": ('Боярская И.А.',), "hours": 3}, 
                {"name": "Биология", "teacher": ('Ашик Е.В.',), "hours": 2}, 
                {"name": "ОБЗР", "teacher": ('Зудинов Н.В.',), "hours": 1}, 
                {"name": "Физра", "teacher": ('Гофман А.С.', 'Петухова А.М.',), "hours": 2}, 
            ] 
        }, 
 
 
]



#Отладочная прога
t_real_hours = {}
for t in teachers:
    t_real_hours[t["name"]] = [0, 0]
    count = 0
    for e in t['exce']:
        count += len(t['exce'][e])
    t_real_hours[t["name"]][1] += (8 * 6 - 2) - count

for c in classes:
    for s in c['subjects']:
        for t in s['teacher']:
            t_real_hours[t][0] += s['hours']

for i in t_real_hours:
    print(f'{i}: {t_real_hours[i][0]}/{t_real_hours[i][1]}')
    if t_real_hours[i][0] + 5 >= t_real_hours[i][1]:
        print("Надо добавить часов")
    if t_real_hours[i][0] > t_real_hours[i][1]:
        print("!!!!!!!!!")
    print("-"*45)


buildings = ["1", "2"]
#Лицей, Графский

days = ["Пн", "Вт", "Ср", "Чт", "Пт", "Сб"]

periods_per_day = 8

# --------------------------------------------
# 2. Создаем модель
# --------------------------------------------
model = cp_model.CpModel()

# x[учитель, класс, корпус, день, урок]


x = {}
for c in classes:
    for s in c['subjects']:
        for d in days:
            for p in range(1, periods_per_day + 1):
                x[(s["teacher"], c["name"], c["buildings"][d], d, p)] = model.NewBoolVar(f"{s["teacher"]}_{c['name']}_{c["buildings"][d]}_{d}_{p}")

# --------------------------------------------
# 3. Ограничения
# --------------------------------------------

# 3.1 Учебный план (все часы должны быть выполнены)
for c in classes:
    for s in c["subjects"]:
        model.Add(
            sum(
                x[(s["teacher"], c["name"], c['buildings'][d], d, p)]
                for d in days
                for p in range(1, periods_per_day + 1)
            ) == s['hours']
        )

for c in classes:
    for d in days:
        for p in range(1, periods_per_day + 1):
            model.Add(
                sum(
                    x[(s['teacher'], c["name"], c['buildings'][d], d, p)]
                    for s in c['subjects']
                ) <= 1
            )
##


# 3.3 Учитель не может вести два урока одновременно
# Сначала соберём, кто в каких классах преподаёт
teacher_to_classes = {}
for c in classes:
    for s in c["subjects"]:
        if s['teacher'][0] != "-":
            teacher_to_classes.setdefault(s["teacher"], []).append(c)

# Теперь для каждого учителя и каждого слота (день, урок) не более одного урока
for tname, class_list in teacher_to_classes.items():
    for d in days:
        for p in range(1, periods_per_day + 1):

            vars_ = [x[(tname, c["name"], c["buildings"][d], d, p)] for c in class_list]

            if (tname == ('Пятибратова К.В.',) and d == "Пт" and p == 1) or (tname == ('Пятибратова К.В.',) and d == "Сб" and p == 8):
                model.Add(sum(vars_) <= 2)   # разрешили 2
            else:
                model.Add(sum(vars_) <= 1)   # всем остальным 1


###


# 3.4 Учитель не может вести при его исключении
for c in classes:
    for s in c['subjects']:
        for t1 in s['teacher']:
            for t2 in teachers:
                if t2['name'] == t1:
                    for d, periods in t2['exce'].items():
                        for p in periods:
                            model.Add(x[(s['teacher'], c['name'], c["buildings"][d], d, p)] == 0)
#

# # # 3.5 Не может быть окон у классов
lesson = {}
for c in classes:
    cname = c["name"]
    for d in days:
        # 1) Индикация «есть ли урок в слоте p» для класса cname в день d
        for p in range(1, periods_per_day + 1):
            lesson[(cname, d, p)] = model.NewBoolVar(f"lesson_{cname}_{d}_{p}")
            model.Add(
                sum(
                    x[(s["teacher"], cname, c["buildings"][d], d, p)]
                    for s in c["subjects"]
                )
                == lesson[(cname, d, p)]
            )
        # 2) Для любой пары слотов i<j с хотя бы одним промежуточным k
        #    требуем, чтобы если в i и в j уроки, 
        #    то во всех k между ними тоже был урок
        for i in range(1, periods_per_day + 1):
            for j in range(i + 2, periods_per_day + 1):
                for k in range(i + 1, j):
                    # если lesson[i]=lesson[j]=1, то LHS=1 => lesson[k] ≥1
                    model.Add(
                        lesson[(cname, d, i)]
                      + lesson[(cname, d, j)]
                      - 1
                      <= lesson[(cname, d, k)]
                    )

# 3.6 Не может быть больше 2 предметов одной группы
for c in classes:
    dic_lesson = {}
    for s in c['subjects']:
        # s["teacher"] всегда кортеж (см. структуру данных)
        if s['name'].endswith("В"):
            name = s['name'][:-1]
        else:
            name = s['name']
        dic_lesson.setdefault(name, []).append(s["teacher"])  # просто s["teacher"], без ()
    
    for d in days:
        for sub, list_t in dic_lesson.items():
            model.Add(
                sum(
                    x[(t, c['name'], c["buildings"][d], d, p)]
                    for p in range(1, periods_per_day + 1)
                    for t in list_t
                ) <= 2
            )

#3.7 Как миниум 6 уроков в день
for c in classes:
    for d in days:
        model.Add(
            sum(
                x[(s['teacher'], c["name"], c["buildings"][d], d, p)]
                for p in range(1, periods_per_day + 1)
                for s in c['subjects']
            ) >= 5
        )


# 3.8 Нет первых двух уроков в пон
for c in classes:
    for s in c["subjects"]:
        model.Add(
            sum(
                x[(s["teacher"], c["name"], c['buildings']["Пн"], "Пн", p)]
                for p in range(1, 3)
            ) == 0
        )

# 3.10 Ограничение на жесткие пары у англ

pair_engl = {}
for c in classes:
    cname = c["name"]
    for s in c["subjects"]:
        if s["name"] == "Англ":
            teacher = s['teacher']
    for d in days:
        for p in range(2, periods_per_day + 1):
            pair_engl[(cname, d, p, p - 1)] = model.NewBoolVar(f"clas_{cname}_day_{d}_p2_{p}_p1_{p - 1}")
            model.Add(
                sum(
                    x[(teacher, cname, c["buildings"][d], d, k)]
                    for k in range(p - 1, p + 1)
                ) == 2
            ).OnlyEnforceIf(pair_engl[(cname, d, p, p - 1)])
            model.Add(
                sum(
                    x[(teacher, cname, c["buildings"][d], d, r)]
                    for r in range(p - 1, p + 1)
                ) < 2
            ).OnlyEnforceIf(pair_engl[(cname, d, p, p - 1)].Not())
    model.Add(
        sum(
            pair_engl[(cname, d, p, p - 1)]
            for d in days
            for p in range(2, periods_per_day + 1)
        ) == 1
    )


# 3.11 Физра в конкретных слотах

busy_phy = {

    "8А":{
        "Пн": (),
        "Вт": (2, 3, ),
        "Ср": (), 
        "Чт": (),
        "Пт": (6, ),
        "Сб": ()
    },#3

    "8Б":{
        "Пн": (),
        "Вт": (),
        "Ср": (), 
        "Чт": (4, 5, ),
        "Пт": (5, ),
        "Сб": ()
    },#3

    "8В":{
        "Пн": (),
        "Вт": (4, 5, ),
        "Ср": (), 
        "Чт": (),
        "Пт": (7, ),
        "Сб": ()
    },#3
##

    "9А":{
        "Пн": (),
        "Вт": (1, ),
        "Ср": (2, 3, ), 
        "Чт": (),
        "Пт": (),
        "Сб": ()
    },#3

    "9Б":{
        "Пн": (3, 4, ),
        "Вт": (8, ),
        "Ср": (), 
        "Чт": (),
        "Пт": (),
        "Сб": ()
    },#3

    "9В":{
        "Пн": (),
        "Вт": (7, ),
        "Ср": (4, 5, ), 
        "Чт": (),
        "Пт": (),
        "Сб": ()
    },#3
##

    "10А":{
        "Пн": (),
        "Вт": (),
        "Ср": (6, ), 
        "Чт": (1, ),
        "Пт": (2, ),
        "Сб": ()
    },
    "10Б":{
        "Пн": (),
        "Вт": (),
        "Ср": (7, ), 
        "Чт": (2, ),
        "Пт": (1, ),
        "Сб": ()
    },

    "10В":{
        "Пн": (7, ),
        "Вт": (),
        "Ср": (), 
        "Чт": (3, ),
        "Пт": (3, ),
        "Сб": ()
    },

    "10Г":{
        "Пн": (8, ),
        "Вт": (),
        "Ср": (8, ), 
        "Чт": (),
        "Пт": (4, ),
        "Сб": ()
    },
# ##

    "11А":{
        "Пн": (),
        "Вт": (2, ),
        "Ср": (), 
        "Чт": (4, ),
        "Пт": (),
        "Сб": ()
    },

    "11Б":{
        "Пн": (),
        "Вт": (3, ),
        "Ср": (), 
        "Чт": (5, ),
        "Пт": (),
        "Сб": ()
    },

    "11В":{
        "Пн": (),
        "Вт": (4, ),
        "Ср": (), 
        "Чт": (6, ),
        "Пт": (),
        "Сб": ()
    },

    "11Г":{
        "Пн": (),
        "Вт": (5, ),
        "Ср": (), 
        "Чт": (7, ),
        "Пт": (),
        "Сб": ()
    },

    "11Д":{
        "Пн": (),
        "Вт": (6, ),
        "Ср": (), 
        "Чт": (8, ),
        "Пт": (),
        "Сб": ()
    },
}


for c in classes:
    # Находим предмет "Физра" для этого класса
    phy_subject = None
    for s in c['subjects']:
        if s['name'] == "Физра":
            phy_subject = s
            break
    
    if phy_subject is None:
        continue  # Пропускаем классы без физры
    
    teacher_phy = phy_subject['teacher']
    num_phy = phy_subject['hours']
    
    # Проверяем, есть ли класс в busy_phy
    if c['name'] not in busy_phy:
        continue
    
    # Создаем список всех слотов для физры
    all_phy_slots = []
    for d in busy_phy[c['name']]:
        for p in busy_phy[c['name']][d]:
            all_phy_slots.append((d, p))
    
    # Добавляем ограничение: физра должна быть только в указанные слоты
    # и количество уроков должно соответствовать num_phy
    model.Add(
        sum(
            x[(teacher_phy, c["name"], c['buildings'][d], d, p)]
            for d, p in all_phy_slots
        ) == num_phy
    )
    
    # Запрещаем физру в другие слоты
    for d in days:
        for p in range(1, periods_per_day + 1):
            if (d, p) not in all_phy_slots:
                model.Add(
                    x[(teacher_phy, c["name"], c['buildings'][d], d, p)] == 0
                )
#

# 3.12 в пон уроки с 3
for c in classes:
    model.Add(
        sum(
            x[(s["teacher"], c["name"], c['buildings']["Пн"], "Пн", 3)]
            for s in c["subjects"]
        ) == 1
    )

# 3.13 макс 1 урок инфы в корпусе 
for b in buildings:  
    for d in days:  
        for p in range(1, periods_per_day + 1):  
            infa_vars = []

            for c in classes:
                # берём только те классы, которые в этот день реально в этом корпусе
                if c["buildings"][d] != b:
                    continue

                for s in c["subjects"]:
                    if "Инфа" in s["name"]:
                        infa_vars.append(x[(s["teacher"], c["name"], b, d, p)])

            if infa_vars:
                model.Add(sum(infa_vars) <= 1)

# 3.14 Не должно быть разрывов в парах

#Инициализация хэштаблицы самой важной здесь
pair_or_not_pair = {}

for c in classes:
    cname = c["name"]
    for s in c["subjects"]:
        name_t = s['teacher']
        for d in days:
            for p in range(1, periods_per_day - 1):
                pair_or_not_pair[(cname, d, name_t, p, p + 1)] = model.NewBoolVar(f"clas_{cname}_day_{d}_name_l{name_t}_p1_{p}_p2_{p + 1}")

for c in classes:
    cname = c["name"]
    for s in c["subjects"]:
        t = s["teacher"]
        for d in days:
            b = c["buildings"][d]
            for p in range(1, periods_per_day - 1):
                model.Add(
                    sum(
                         x[(t, cname, b, d, z)]
                         for z in range(p, p + 2)
                    ) == 2
                ).OnlyEnforceIf(pair_or_not_pair[(cname, d, t, p, p + 1)])
                model.Add(
                    sum(
                         x[(t, cname, b, d, z)]
                         for z in range(p, p + 2)
                    ) != 2
                ).OnlyEnforceIf(pair_or_not_pair[(cname, d, t, p, p + 1)].Not())
###

#Хештаблица ровно 1 урок в день у учителя
have_a_les = {}
for c in classes:
    cname = c["name"]
    for s in c["subjects"]:
        name_t = s['teacher']
        for d in days:
                have_a_les[(cname, d, name_t)] = model.NewBoolVar(f"clas_{cname}_day_{d}_name_l{name_t}")

for c in classes:
    cname = c["name"]
    for s in c["subjects"]:
        t = s["teacher"]
        for d in days:
            b = c["buildings"][d]
            model.Add(
                sum(
                     x[(t, cname, b, d, p)]
                     for p in range(1, periods_per_day + 1)
                ) == 1
            ).OnlyEnforceIf(have_a_les[(cname, d, t)])
            model.Add(
                sum(
                     x[(t, cname, b, d, p)]
                     for p in range(1, periods_per_day + 1)
                ) != 1
            ).OnlyEnforceIf(have_a_les[(cname, d, t)].Not())
###

#Хештаблица 0 уроков в день
not_have_a_les = {}
for c in classes:
    cname = c["name"]
    for s in c["subjects"]:
        name_t = s['teacher']
        for d in days:
                not_have_a_les[(cname, d, name_t)] = model.NewBoolVar(f"clas_{cname}_day_{d}_name_l{name_t}")

for c in classes:
    cname = c["name"]
    for s in c["subjects"]:
        t = s["teacher"]
        for d in days:
            b = c["buildings"][d]
            model.Add(
                sum(
                     x[(t, cname, b, d, p)]
                     for p in range(1, periods_per_day + 1)
                ) == 0
            ).OnlyEnforceIf(not_have_a_les[(cname, d, t)])
            model.Add(
                sum(
                     x[(t, cname, b, d, p)]
                     for p in range(1, periods_per_day + 1)
                ) != 0
            ).OnlyEnforceIf(not_have_a_les[(cname, d, t)].Not())
###


for c in classes:
    cname = c["name"]
    for s in c["subjects"]:
        for d in days:
            model.Add(sum
                    (
            pair_or_not_pair[(cname, d, s["teacher"], p, p + 1)]
            for p in range(1, periods_per_day - 1)
                ) == 1
            ).OnlyEnforceIf([have_a_les[(cname, d, s["teacher"])].Not(), not_have_a_les[(cname, d, s["teacher"])].Not()])

# 3.15 Если это доп урок, то можно иметь 8 уроков

extra_les = {
            "8А": ('Киселев А.С.', 'Золотухина Е.Л.', 'Гайдукова Е.В.', 'Вовина П.А.'), 
            "8Б": ('Корнев В.А.', 'Ганкевич В.Д.', 'Шерстнева Е.С.', 'Вовина П.А.'),
            "8В": ('Черниговская Н.В.', 'Бармасова Г.А.', 'Бабушкин А.Д.', 'Вовина П.А.'),
            
            "9А": ('Золотухина Е.Л.', 'Молочников А.А.', 'Полякова А.А.'),
            "9Б": ('Золотухина Е.Л.', 'Наумова М.В.', 'Бабушкин А.Д.'),
            "9В": ('Бармасова Г.А.', 'Наумова М.В.', 'Гущина Н.В.'),
            
            "10А": ("Бабушкина А.А.","Бабушкин А.Д.","Назаренко К.Б.", "Бармасова Г.А."), 
            "10Б": ("Гущина Н.В.","Назаренко К.Б.", "Бармасова Г.А."),
            "10В": ("Гайдукова Е.В.", "Бабушкин А.Д.", "Назаренко К.Б.", "Бармасова Г.А."),
            "10Г": ("Офимкина П.А.", "Бабушкина А.А.", "Строганова В.А.", "Бармасова Г.А."),

            "11А": ("Офимкина П.А.", "Ковлягин М.С.", "Ганкевич В.Д."),
            "11Б": ("Каретникова А.С.", "Ковлягин М.С.", "Ганкевич В.Д."),
            "11В": ("Золотухина Е.Л.", "Ковлягин М.С.", "Гущина Н.В."),
            "11Г": ("Гайдукова Е.В.", "Ковлягин М.С.", "Ашик Е.В."),
            "11Д": ("Ашик Е.В.", "Ковлягин М.С.", "Каретникова А.С.")
            }

num_of_lessons = {}
for c in classes:
    cname = c["name"]
    for d in days:
        num_of_lessons[(cname, d)] = model.NewIntVar(0, periods_per_day, f"lesson_{cname}_{d}")
        model.Add(
            sum(
                x[(s["teacher"], cname, c["buildings"][d], d, p)]
                for s in c["subjects"]
                for p in range(1, periods_per_day + 1)
            ) == num_of_lessons[(cname, d)])

num_of_teacher = {}
for c in classes:
    cname = c["name"]
    for d in days:
        for s in c["subjects"]:
            num_of_teacher[(cname, d, s["teacher"][0])] = model.NewBoolVar(f"lesson_{cname}_{d}_{s["teacher"][0]}")
            model.Add(
                sum(
                    x[(s["teacher"], cname, c["buildings"][d], d, p)]
                    for p in range(1, periods_per_day + 1)
                ) >= 1).OnlyEnforceIf(num_of_teacher[(cname, d, s["teacher"][0])])
            model.Add(
                sum(
                    x[(s["teacher"], cname, c["buildings"][d], d, p)]
                    for p in range(1, periods_per_day + 1)
                ) == 0).OnlyEnforceIf(num_of_teacher[(cname, d, s["teacher"][0])].Not())

eight_or_not = {}
state = {}#!!!!!!!!!!!!
add = {}#!!!!!!!!!!!!
for c in classes:
    cname = c["name"]
    if cname not in extra_les:
        continue
    

    ###Инициализация
    stage = len(extra_les[cname])
    for i_t in range(len(extra_les[cname])):
        teacher = extra_les[cname][i_t]
        
        add[(i_t, cname)] = model.NewBoolVar(f"add_{i_t}")
        state[(i_t, cname)] = {
        d: model.NewBoolVar(f"state_{cname}_{teacher}_{d}")
        for d in days
        }
        for d in days:
            model.Add(state[(i_t, cname)][d] <= num_of_teacher[(cname, d, teacher)])

    #Монотонность
    for i_t in range(1, len(extra_les[cname])):
        for d in days:
            model.Add(state[(i_t, cname)][d] >= state[(i_t - 1, cname)][d])
    
    ###Преобразования
    for i_t in range(1, len(extra_les[cname])):
        model.Add(
            sum(state[(i_t, cname)][d] for d in days)
            - sum(state[(i_t - 1, cname)][d] for d in days)
            == add[(i_t, cname)]
        )

    
    for d in days:
        eight_or_not[(d, cname)] = model.NewBoolVar(f"class_{cname}_day_{d}")
        model.Add(sum(
                    state[(i_t, cname)][d]
                    for i_t in range(len(extra_les[cname]))
                )>= 1).OnlyEnforceIf(eight_or_not[(d, cname)])
        model.Add(sum(
                    state[(i_t, cname)][d]
                    for i_t in range(len(extra_les[cname]))
                )==0).OnlyEnforceIf(eight_or_not[(d, cname)].Not())
    
    for i_t in range(1, len(extra_les[cname])):
        for d in days:
            model.Add(num_of_lessons[(cname, d)] <= 7).OnlyEnforceIf(eight_or_not[(d, cname)].Not())
            model.Add(num_of_lessons[(cname, d)] <= 8).OnlyEnforceIf(eight_or_not[(d, cname)])

#3.16 Икспб в конкретных слотах
# model.Add(x[(('Пятибратова К.В.',), "8А", "1", "Чт", 8)] == 1)
# model.Add(x[(('Пятибратова К.В.',), "8Б", "1", "Сб", 8)] == 1)
# model.Add(x[(('Пятибратова К.В.',), "8В", "1", "Сб", 8)] == 1)

# model.Add(x[(('Пятибратова К.В.',), "9А", "1", "Пт", 1)] == 1)
# model.Add(x[(('Пятибратова К.В.',), "9Б", "1", "Пт", 1)] == 1)
# model.Add(x[(('Пятибратова К.В.',), "9В", "2", "Чт", 1)] == 1)

# --------------------------------------------
# 4.0 Вспомогалки для оптимизации
# --------------------------------------------

# 1) Разворачиваем назначение: 
#    teacher_to_assignments[teacher_name] = list of (teacher_key, class_obj)
teacher_to_assignments = {}
for c in classes:
    for s in c["subjects"]: # может быть строка или кортеж
        for t in s["teacher"]:
            teacher_to_assignments.setdefault(t, []).append((s["teacher"], c))

# 2) Индикатор “есть ли урок у teacher_name в день d, период p”
lesson_t = {}
for teacher_name, assigns in teacher_to_assignments.items():
    for d in days:
        for p in range(1, periods_per_day + 1):
            lt = model.NewBoolVar(f"lesson_{teacher_name}_{d}_{p}")
            lesson_t[(teacher_name, d, p)] = lt

            s = sum(
                x[(tkey, cl["name"], cl["buildings"][d], d, p)]
                for (tkey, cl) in assigns
            )
            model.Add(s >= 1).OnlyEnforceIf(lt)
            model.Add(s == 0).OnlyEnforceIf(lt.Not())


# 3.17 Жёсткое ограничение: для каждого преподавателя с trans_1 == 1
# запрещается менять корпус сразу подряд (p → p+1) — т.е. переход без окна
for t in teachers:
    if t.get("trans_1", 0) != 1:
        continue
    teacher_name = t["name"]
    assigns = teacher_to_assignments.get(teacher_name, [])
    if not assigns:
        continue
    for d in days:
        for p in range(1, periods_per_day):
            for (tkey1, c1), (tkey2, c2) in product(assigns, assigns):
                b1 = c1["buildings"][d]
                b2 = c2["buildings"][d]
                if b1 == b2:
                    continue  # не смена корпуса
                x1 = x[(tkey1, c1["name"], b1, d, p)]
                x2 = x[(tkey2, c2["name"], b2, d, p + 1)]
                # запретить одновременно урок в корпусе b1 на p и в другом корпусе b2 на p+1
                model.AddBoolOr([x1.Not(), x2.Not()])




# --------------------------------------------
# 4.1 Оптимизация переходов
# --------------------------------------------

# Штрафные переменные transitions[(teacher_name, d, p, q)]
transitions = {}
for teacher_name, assigns in teacher_to_assignments.items():
    plus = 1
    for t in teachers:
        if t['name'] == teacher_name:
            if t.get('trans_1', 0) == 1:
                plus = 2  # требует хотя бы одного пустого периода между p и q
            break
        
    for d in days:
        # для каждой пары уроков p<q, где между ними нет других уроков
        for p in range(1, periods_per_day + 1):
            for q in range(p + plus, periods_per_day + 1):
                gap_clear = model.NewBoolVar(f"gap_clear_{teacher_name}_{d}_{p}_{q}")
                model.Add(
                    sum(lesson_t[(teacher_name, d, k)] for k in range(p+1, q)) == 0
                ).OnlyEnforceIf(gap_clear)
                model.Add(
                    sum(lesson_t[(teacher_name, d, k)] for k in range(p+1, q)) > 0
                ).OnlyEnforceIf(gap_clear.Not())

                # b) is_next = 1 ⇔ урок в p, урок в q и gap_clear
                is_next = model.NewBoolVar(f"is_next_{teacher_name}_{d}_{p}_{q}")
                model.AddBoolAnd([
                    lesson_t[(teacher_name, d, p)],
                    lesson_t[(teacher_name, d, q)],
                    gap_clear
                ]).OnlyEnforceIf(is_next)
                model.AddBoolOr([
                    lesson_t[(teacher_name, d, p)].Not(),
                    lesson_t[(teacher_name, d, q)].Not(),
                    gap_clear.Not()
                ]).OnlyEnforceIf(is_next.Not())

                # c) переход между корпусами
                tr = model.NewBoolVar(f"trans_{teacher_name}_{d}_{p}_{q}")
                transitions[(teacher_name, d, p, q)] = tr

                # d) проверяем смену корпуса через все сочетания назначений
                ors = []
                for (tkey1, c1), (tkey2, c2) in product(assigns, assigns):
                    b1 = c1["buildings"][d]
                    b2 = c2["buildings"][d]
                    if b1 == b2:
                        continue
                    x1 = x[(tkey1, c1["name"], b1, d, p)]
                    x2 = x[(tkey2, c2["name"], b2, d, q)]
                    tmp = model.NewBoolVar(f"tmp_tr_{teacher_name}_{d}_{p}_{q}_{b1}_{b2}")
                    model.AddBoolAnd([is_next, x1, x2]).OnlyEnforceIf(tmp)
                    model.AddBoolOr([is_next.Not(), x1.Not(), x2.Not()]).OnlyEnforceIf(tmp.Not())
                    ors.append(tmp)

                if ors:
                    model.AddBoolOr(ors).OnlyEnforceIf(tr)
                    model.AddBoolAnd([lit.Not() for lit in ors]).OnlyEnforceIf(tr.Not())
# --------------------------------------------
# 4.2 Оптимизация «окон»
# --------------------------------------------

windows = {}

for teacher_name, assigns in teacher_to_assignments.items():
    for d in days:
        # для каждой пары уроков p<q, где между ними нет других уроков
        for p in range(1, periods_per_day + 1):
            for q in range(p + 1, periods_per_day + 1):
                if q != p + 1:
                    # a) gap_clear = 1 ⇔ нет уроков между p и q
                    gap_clear = model.NewBoolVar(f"gap_clear_{teacher_name}_{d}_{p}_{q}")
                    model.Add(
                        sum(lesson_t[(teacher_name, d, k)] for k in range(p+1, q)) == 0
                    ).OnlyEnforceIf(gap_clear)
                    model.Add(
                        sum(lesson_t[(teacher_name, d, k)] for k in range(p+1, q)) > 0
                    ).OnlyEnforceIf(gap_clear.Not())

                    # b) is_next = 1 ⇔ урок в p, урок в q, и gap_clear
                    is_next = model.NewBoolVar(f"is_next_{teacher_name}_{d}_{p}_{q}")
                    model.AddBoolAnd([
                        lesson_t[(teacher_name, d, p)],
                        lesson_t[(teacher_name, d, q)],
                        gap_clear
                    ]).OnlyEnforceIf(is_next)
                    model.AddBoolOr([
                        lesson_t[(teacher_name, d, p)].Not(),
                        lesson_t[(teacher_name, d, q)].Not(),
                        gap_clear.Not()
                    ]).OnlyEnforceIf(is_next.Not())

                    # c) окнонная переменная
                    wd = model.NewBoolVar(f"trans_{teacher_name}_{d}_{p}_{q}")
                    windows[(teacher_name, d, p, q)] = wd

                    # d) для каждого сочетания назначений проверяем смену корпуса
                    ors = []
                    for (tkey1, c1), (tkey2, c2) in product(assigns, assigns):
                        b1 = c1["buildings"][d]
                        b2 = c2["buildings"][d]
                        x1 = x[(tkey1, c1["name"], b1, d, p)]
                        x2 = x[(tkey2, c2["name"], b2, d, q)]
                        if b1 != b2 and q == p + 2: #Не считать оконо если 1 урок под переход
                            continue
                        tmp = model.NewBoolVar(f"tmp_tr_{teacher_name}_{d}_{p}_{q}_{b1}_{b2}")
                        model.AddBoolAnd([is_next, x1, x2]).OnlyEnforceIf(tmp)
                        model.AddBoolOr([is_next.Not(), x1.Not(), x2.Not()]).OnlyEnforceIf(tmp.Not())
                        ors.append(tmp)

                    # e) устанавливаем tr ↔ OR(ors)
                    if ors:
                        model.AddBoolOr(ors).OnlyEnforceIf(wd)
                        model.AddBoolAnd([lit.Not() for lit in ors]).OnlyEnforceIf(wd.Not())

# --------------------------------------------
# 4.3 Оптимизация пар уроков
# --------------------------------------------
pairs = {}

teachers_to_assignments = {}
for c in classes:
    for s in c["subjects"]: 
        if s['hours'] != 1:
            teachers_to_assignments.setdefault(s['teacher'], []).append(c)

# 2.2) Индикатор “есть ли урок у teacher_name в день d, период p”
for teacher_name, class_list in teachers_to_assignments.items():
    for d in days:
        for p in range(1, periods_per_day):
            pair_var = model.NewBoolVar(f"pair_{teacher_name}_{d}_{p}_{p+1}")
            pairs[(teacher_name, d, p)] = pair_var

            # Пусть l_p = lesson_t[(teacher_name,d,p)], l_q = lesson_t[(teacher_name,d,p+1)]
            l_p = sum(x[(teacher_name, cl["name"], cl["buildings"][d], d, p)]
                      for cl in class_list)
            l_q = sum(x[(teacher_name, cl["name"], cl["buildings"][d], d, p+1)]
                      for cl in class_list)

            # Линейная связь pair_var ⇔ (l_p ≥1 ∧ l_q ≥1):
            # 1) pair_var ≤ (l_p ≥1)  и  pair_var ≤ (l_q ≥1)
            model.Add(l_p >= 1).OnlyEnforceIf(pair_var)
            model.Add(l_q >= 1).OnlyEnforceIf(pair_var)
            model.Add(pair_var <= l_p)    # если pair_var=1, l_p must be ≥1
            model.Add(pair_var <= l_q)    # if pair_var=1, l_q must be ≥1

            # 2) Если оба есть, то pair_var может быть 1, иначе он принудительно 0:
            #    l_p + l_q - 1 ≤ pair_var * 2
            #    но проще: l_p + l_q - 1 ≤ pair_var*2  ⟹ если l_p=l_q=1, RHS=2 ⇒ pair_var may be 1
            model.Add(l_p + l_q - 1 <= pair_var * 2)


# Целевая функция: минимизируем переходы, окна у учителей + макимизируем пары 
model.Minimize(
    sum(transitions.values()) * 10 +
    sum(windows.values()) * 4 - 
    sum(pairs.values()) * 1
)


# --------------------------------------------
# 5. Решение 
# --------------------------------------------
solver = cp_model.CpSolver()
solver.parameters.max_time_in_seconds = 30
solver.parameters.log_search_progress = True
solver.parameters.cp_model_presolve = True
solver.parameters.num_search_workers = 7
solver.parameters.linearization_level = 2
solver.parameters.cp_model_probing_level = 0
status = solver.Solve(model)

if status == cp_model.OPTIMAL or status == cp_model.FEASIBLE:
    print("Расписание составлено успешно!")


    txt_output_windows = []
    txt_output_trans = []
    
    for (teacher, d, p, q), wind in windows.items():
        if solver.Value(wind):
            txt_output_windows.append((teacher, d, p, q))
    print(f"Окна у учителей: {len(txt_output_windows)}")
    print(txt_output_windows)

    for (teacher, d, p, q), trans in transitions.items():
        if solver.Value(trans):
            txt_output_trans.append((teacher, d, p, q))
    print(f"Переходы между корпусами: {len(txt_output_trans)}")
    print(txt_output_trans)
    print("-"*70)

    # Собираем расписание в таблицу
    schedule = []
    for d in days:
        for p in range(1, periods_per_day + 1):
            for c in classes:
                for s in c['subjects']:
                    if solver.Value(x[(s["teacher"], c["name"], c["buildings"][d], d, p)]) == 1:
                                    schedule.append({
                                        "День": d,
                                        "Урок": p,
                                        "Класс": c["name"],
                                        "Учитель": s["teacher"],
                                        "Корпус": c["buildings"][d],
                                        "Предмет": s['name']
                                    })
else:
    print("Не удалось найти решение. Попробуйте ослабить ограничения.")

count = 0
for a in schedule:
    # print(a)
    count += 1
print(f"Кол-во уркоов до добавления кабинетов: {count}")

print("-"*70)
# --------------------------------------------
# 6. Выбор кабинета
# --------------------------------------------



# ==================== НАСТРОЙКА: фикс-кабинеты информатики ====================
# Корпус "1" -> ОТ_1 и ОТ_2 (для двух групп), корпус "2" -> 401 и 407
# Если у тебя реально другие названия — поменяй здесь.
INF_FIXED_BY_BUILDING = {
    "1": ["ОТ_1", "ОТ_2"],
    "2": ["401", "407"],
}

# ==================== НОРМАЛИЗАЦИЯ ДАННЫХ (обязательно) ====================
def norm_str(x):
    return str(x).strip()

def norm_teachers(x):
    # Учитель ВСЕГДА list[str]
    if x is None:
        return []
    if isinstance(x, str):
        s = x.strip()
        return [s] if s else []
    return [str(t).strip() for t in x if str(t).strip()]

# schedule
for l in schedule:
    l["Класс"] = norm_str(l["Класс"])
    l["День"] = norm_str(l["День"])
    l["Урок"] = int(l["Урок"])                 # int
    l["Корпус"] = norm_str(l["Корпус"])        # str
    l["Предмет"] = norm_str(l["Предмет"])
    l["Учитель"] = norm_teachers(l["Учитель"]) # list[str]

# classes
for c in classes:
    c["name"] = norm_str(c["name"])

# rooms
for r in rooms:
    r["name"] = norm_str(r["name"])
    r["building"] = norm_str(r["building"])
    r["size"] = norm_str(r.get("size", ""))
    r["prio"] = norm_str(r.get("prio", "Нет прио"))

# ==================== ordered_schedule[class][day][period] ====================
ordered_schedule = {}
for c in classes:
    cname = c["name"]
    ordered_schedule[cname] = {}
    for d in days:
        ordered_schedule[cname][d] = {}
        for p in range(1, periods_per_day + 1):
            ordered_schedule[cname][d][p] = 0

for l in schedule:
    cname = l["Класс"]
    day = l["День"]
    p = int(l["Урок"])
    ordered_schedule[cname][day][p] = [l["Учитель"], str(l["Корпус"]), l["Предмет"]]

# ==================== busy_classes[day][period_str] = [(room_name, building), ...] ====================
busy_classes = {d: {str(p): [] for p in range(1, periods_per_day + 1)} for d in days}

# ==================== ВСПОМОГАТЕЛЬНОЕ: получить dict кабинета (или создать заглушку) ====================
def get_room_dict(room_name: str, building: str):
    room_name = norm_str(room_name)
    building = norm_str(building)
    rr = next((r for r in rooms if r["name"] == room_name and r["building"] == building), None)
    if rr is not None:
        return rr
    # если кабинет не найден в rooms — создаём заглушку, чтобы код не падал
    rr = {"name": room_name, "building": building, "size": "Маленький", "prio": "Инфа"}
    rooms.append(rr)
    return rr

def reserve_rooms(day: str, period: int, chosen_rooms: list):
    """chosen_rooms = list[dict], бронируем в busy_classes"""
    for r in chosen_rooms:
        busy_classes[day][str(period)].append((r["name"], r["building"]))

# ==================== ПРЕДПРОГОНКА: СНАЧАЛА СТАВИМ ИНФОРМАТИКЕ НУЖНЫЕ КАБИНЕТЫ ====================
# Это делается ДО общего подбора, и сразу бронирует кабинеты.
for c in classes:
    cname = c["name"]
    for d in days:
        p = 1
        while p <= periods_per_day:
            entry = ordered_schedule[cname][d][p]
            if entry == 0:
                p += 1
                continue

            subject = entry[2]
            building = entry[1]
            teachers_list = entry[0]

            # ТОЛЬКО информатика
            if "Инфа" not in subject:
                p += 1
                continue

            need = 1 if len(teachers_list) <= 1 else 2
            fixed_names = INF_FIXED_BY_BUILDING.get(building, [])
            fixed_names = fixed_names[:need]

            # если в маппинге нет нужного количества кабинетов — просто пропускаем (пусть общий подбор решит)
            if len(fixed_names) != need:
                p += 1
                continue

            chosen = [get_room_dict(rn, building) for rn in fixed_names]

            # если это пара (на следующий урок тоже Инфа в том же корпусе) — бронируем сразу на два урока
            is_pair = False
            if p < periods_per_day:
                nxt = ordered_schedule[cname][d][p + 1]
                if nxt != 0 and ("Инфа" in nxt[2]) and (nxt[1] == building):
                    need2 = 1 if len(nxt[0]) <= 1 else 2
                    # важно: чтобы на обоих уроках одинаково 1/2 кабинета
                    if need2 == need:
                        is_pair = True

            # проверим занятость (если уже занято — не ставим жёстко, пусть дальше best-effort попробует)
            def free_for(period_check: int):
                return all((r["name"], r["building"]) not in busy_classes[d][str(period_check)] for r in chosen)

            if is_pair:
                if free_for(p) and free_for(p + 1):
                    # записываем выбранные кабинеты в ОБА урока и бронируем
                    if len(ordered_schedule[cname][d][p]) < 4:
                        ordered_schedule[cname][d][p].append(chosen)
                    else:
                        ordered_schedule[cname][d][p][3] = chosen

                    if len(ordered_schedule[cname][d][p + 1]) < 4:
                        ordered_schedule[cname][d][p + 1].append(chosen)
                    else:
                        ordered_schedule[cname][d][p + 1][3] = chosen

                    reserve_rooms(d, p, chosen)
                    reserve_rooms(d, p + 1, chosen)
                    p += 2
                    continue
                # если на пару не свободно — попробуем хотя бы на текущий
                if free_for(p):
                    if len(ordered_schedule[cname][d][p]) < 4:
                        ordered_schedule[cname][d][p].append(chosen)
                    else:
                        ordered_schedule[cname][d][p][3] = chosen
                    reserve_rooms(d, p, chosen)
                p += 1
                continue
            else:
                if free_for(p):
                    if len(ordered_schedule[cname][d][p]) < 4:
                        ordered_schedule[cname][d][p].append(chosen)
                    else:
                        ordered_schedule[cname][d][p][3] = chosen
                    reserve_rooms(d, p, chosen)
                p += 1
                continue


# ==================== ВЫБОР КАБИНЕТОВ: строгий -> слабее -> ещё слабее ====================
def pick_rooms_core(ordered_schedule, rooms, busy_classes, k, keys, check_periods,
                    allow_other_buildings=False, ignore_subject_prio=False, allow_ot=False):
    """
    Возвращает список из k кабинетов (list[dict]) или [] если не найдено.
    """
    cname, day, p = keys
    entry = ordered_schedule[cname][day][p]
    teach = entry[0]          # list[str]
    building = entry[1]       # str
    subject = entry[2]        # str

    def is_free(room_name, bld):
        for pp in check_periods:
            if (room_name, bld) in busy_classes[day][str(pp)]:
                return False
        return True

    # --- ПРАВИЛО РАЗМЕРА ---
    # урок для всего класса -> только "Большой"
    # урок для групп -> можно "Маленький"
    is_group_lesson = (len(teach) > 1)
    sizes = ("Маленький", "Большой") if is_group_lesson else ("Большой",)

    # предметный приоритет (англ/инфа)
    if "Инфа" in subject:
        subj_prio = None if ignore_subject_prio else "Инфа"
    elif "Англ" in subject:
        subj_prio = None if ignore_subject_prio else "Англ"
    else:
        subj_prio = None

    def ok_room(r):
        if not allow_other_buildings and r["building"] != building:
            return False
        if not allow_ot and r["name"] in ("ОТ_1", "ОТ_2"):
            return False
        if r.get("prio") == "Физра":
            return False
        if not is_free(r["name"], r["building"]):
            return False
        return True

    def subject_ok(r):
        if subj_prio is None:
            return True
        return subj_prio in r["prio"].split("/")

    # ---------- 1) teacher prio ----------
    prio_lists = []
    for tname in teach:
        pref = []
        for t_g in teachers:
            if norm_str(t_g.get("name")) == tname:
                pmap = t_g.get("prio", {})
                pval = pmap.get(building)
                if isinstance(pval, str) and pval.strip():
                    pref = [pval.strip()]
                elif isinstance(pval, list):
                    pref = [norm_str(x) for x in pval if norm_str(x)]
                break
        prio_lists.append(pref)

    chosen_names = []
    for pref in prio_lists:
        found = None
        for rname in pref:
            if rname not in chosen_names and is_free(rname, building):
                found = rname
                break
        if found:
            chosen_names.append(found)

    if len(chosen_names) >= k:
        out = []
        for rname in chosen_names[:k]:
            rr = next((r for r in rooms if r["name"] == rname and r["building"] == building), None)
            if rr is None:
                out = []
                break
            out.append(rr)
        if len(out) == k:
            return out

    # ---------- 2) подбор по size + прио предмета ----------
    cands = []
    for sz in sizes:
        cands += [r for r in rooms if ok_room(r) and r["size"] == sz and subject_ok(r)]
    if len(cands) >= k:
        return random.sample(cands, k)

    # ---------- 3) подбор по size без прио предмета ----------
    cands = []
    for sz in sizes:
        cands += [r for r in rooms if ok_room(r) and r["size"] == sz]
    if len(cands) >= k:
        return random.sample(cands, k)

    # ---------- 4) финальный fallback: любые свободные, НО size НЕ отпускаем ----------
    cands = [r for r in rooms if ok_room(r) and r["size"] in sizes]
    if len(cands) >= k:
        return random.sample(cands, k)

    return []


def pick_rooms_best_effort(ordered_schedule, rooms, busy_classes, k, keys, check_periods):
    chosen = pick_rooms_core(ordered_schedule, rooms, busy_classes, k, keys, check_periods,
                             allow_other_buildings=False, ignore_subject_prio=False, allow_ot=False)
    if chosen:
        return chosen

    chosen = pick_rooms_core(ordered_schedule, rooms, busy_classes, k, keys, check_periods,
                             allow_other_buildings=False, ignore_subject_prio=True, allow_ot=False)
    if chosen:
        return chosen

    chosen = pick_rooms_core(ordered_schedule, rooms, busy_classes, k, keys, check_periods,
                             allow_other_buildings=True, ignore_subject_prio=True, allow_ot=False)
    if chosen:
        return chosen

    return pick_rooms_core(ordered_schedule, rooms, busy_classes, k, keys, check_periods,
                           allow_other_buildings=True, ignore_subject_prio=True, allow_ot=True)


# ==================== СБОР final_timetable (пары бронируем на 2 урока сразу) ====================
final_timetable = []

for c in classes:
    cname = c["name"]
    for d in days:
        for p in range(1, periods_per_day + 1):
            entry = ordered_schedule[cname][d][p]
            if entry == 0:
                continue

            teachers_list = entry[0]
            building = entry[1]
            subject = entry[2]

            # физра
            if subject == "Физра":
                room_field = "УОО" if building == "1" else "СЗ"
                final_timetable.append({
                    "День": d, "Урок": p, "Класс": cname,
                    "Учитель": ", ".join(teachers_list),
                    "Корпус": building, "Предмет": subject, "Кабинет": room_field
                })
                continue

            need = 1 if len(teachers_list) <= 1 else 2

            # уже назначено ранее (например второй урок пары или пред-прогонка информатики)
            if len(entry) >= 4 and entry[3]:
                chosen = entry[3]
                room_field = chosen[0]["name"] if need == 1 else f"{chosen[0]['name']}, {chosen[1]['name']}"
                final_timetable.append({
                    "День": d, "Урок": p, "Класс": cname,
                    "Учитель": ", ".join(teachers_list),
                    "Корпус": building, "Предмет": subject, "Кабинет": room_field
                })
                continue

            # пара: p и p+1 одинаковый предмет и корпус
            is_pair = False
            if p < periods_per_day:
                nxt = ordered_schedule[cname][d][p + 1]
                if nxt != 0 and nxt[2] == subject and nxt[1] == building:
                    need2 = 1 if len(nxt[0]) <= 1 else 2
                    if need2 == need and (len(nxt) < 4 or not nxt[3]):
                        is_pair = True

            if is_pair:
                chosen = pick_rooms_best_effort(ordered_schedule, rooms, busy_classes, need, (cname, d, p), [p, p + 1])

                if chosen:
                    for pp in (p, p + 1):
                        for r in chosen:
                            busy_classes[d][str(pp)].append((r["name"], r["building"]))
                        if len(ordered_schedule[cname][d][pp]) < 4:
                            ordered_schedule[cname][d][pp].append(chosen)
                        else:
                            ordered_schedule[cname][d][pp][3] = chosen

                    room_field = chosen[0]["name"] if need == 1 else f"{chosen[0]['name']}, {chosen[1]['name']}"
                else:
                    # если на пару не получилось — ставим хотя бы на текущий
                    chosen1 = pick_rooms_best_effort(ordered_schedule, rooms, busy_classes, need, (cname, d, p), [p])
                    if chosen1:
                        for r in chosen1:
                            busy_classes[d][str(p)].append((r["name"], r["building"]))
                        if len(ordered_schedule[cname][d][p]) < 4:
                            ordered_schedule[cname][d][p].append(chosen1)
                        else:
                            ordered_schedule[cname][d][p][3] = chosen1
                        room_field = chosen1[0]["name"] if need == 1 else f"{chosen1[0]['name']}, {chosen1[1]['name']}"
                    else:
                        room_field = "НЕТ КАБ"
            else:
                chosen = pick_rooms_best_effort(ordered_schedule, rooms, busy_classes, need, (cname, d, p), [p])
                if chosen:
                    for r in chosen:
                        busy_classes[d][str(p)].append((r["name"], r["building"]))
                    if len(ordered_schedule[cname][d][p]) < 4:
                        ordered_schedule[cname][d][p].append(chosen)
                    else:
                        ordered_schedule[cname][d][p][3] = chosen
                    room_field = chosen[0]["name"] if need == 1 else f"{chosen[0]['name']}, {chosen[1]['name']}"
                else:
                    room_field = "НЕТ КАБ"

            final_timetable.append({
                "День": d, "Урок": p, "Класс": cname,
                "Учитель": ", ".join(teachers_list),
                "Корпус": building, "Предмет": subject, "Кабинет": room_field
            })



count = 0
for a in final_timetable:
    # print(a)
    count += 1

print(f"Кол-во уроков после добваления кабинетов: {count}")

print("-"*70)


count = 0
for c in classes:
    count_c = 0
    for s in c["subjects"]:
        count_c += s['hours']
    count += count_c
    print(f"{c['name']}: {count_c} часов")

print("-"*70)

print(f"Нормативно должно быть: {count}")


# # --------------------------------------------
# # 7. Вывод расписания в excel 
# # --------------------------------------------

wb = Workbook()
list_of_classes = []

for items in final_timetable:
    if items["Класс"] in list_of_classes:
        continue
    else:
        list_of_classes.append(items["Класс"])


t_to_color = {}

for t in teachers:
    t_to_color[t['name']] = t['color']



# s_list_of_classes = sorted(list_of_classes)
weight_letters_ = {
    "8А": 1,
    "8Б": 2,
    "8В": 3,
    "8Г": 4,
    "8Д": 5,

    "9А": 6,
    "9Б": 7,
    "9В": 8,
    "9Г": 9,
    "9Д": 10,

    "10А": 11,
    "10Б": 12,
    "10В": 13,
    "10Г": 14,
    "10Д": 15,

    "11А": 16,
    "11Б": 17,
    "11В": 18,
    "11Г": 19,
    "11Д": 20,

}

n = 1
while n < len(list_of_classes):
    for i in range(len(list_of_classes)-n):
        if weight_letters_[list_of_classes[i]] > weight_letters_[list_of_classes[i + 1]]:
            list_of_classes[i],  list_of_classes[i + 1] = list_of_classes[i + 1], list_of_classes[i]
    n += 1

s_list_of_classes = list_of_classes

# print(s_list_of_classes)

ws = wb.active


help_class = {} 
for i in range(0, len(list_of_classes)): 
    help_class[list_of_classes[i]] = i

#Дни недели 
vertical_text = Alignment(text_rotation=90, horizontal='center',  
                          vertical='center') 
 
help_days_fully = { 
    "Пн": ("Понедельник",  
           PatternFill(start_color='F0E68C', fill_type='solid') ,  
            Font(color='000000', size=13, bold = True), 1), 
    "Вт": ("Вторник",  
           PatternFill(start_color='6A5ACD', fill_type='solid') ,  
            Font(color='000000', size=13, bold = True), 2), 
    "Ср": ("Среда",  
           PatternFill(start_color='1E90FF', fill_type='solid') ,  
            Font(color='000000', size=13, bold = True), 3), 
    "Чт": ("Четверг",  
           PatternFill(start_color='FF69B4', fill_type='solid') ,  
            Font(color='000000', size=13, bold = True), 4), 
    "Пт": ("Пятница",  
           PatternFill(start_color='EE82EE', fill_type='solid') ,  
            Font(color='000000', size=13, bold = True), 5), 
    "Сб": ("Суббота",  
           PatternFill(start_color='2E8B57', fill_type='solid') ,  
            Font(color='000000', size=13, bold = True), 6), 
} 
 
for idx, (day, fill, text, n) in enumerate(help_days_fully.values(), start=1): 
    # Получаем букву колонки 
    column_1 = get_column_letter(1)  
    row = (idx - 1) * 9 + (idx - 1) * 2 + 3 
     
    # Записываем день недели 
    cell = ws[f"{column_1}{row}"] 
    cell.value = day 
     
    cell.fill = fill  # Фон 
    cell.font = text 
    # Применяем вертикальную ориентацию 
    cell.alignment = vertical_text 
     
    # Увеличиваем ширину колонки 
    ws.column_dimensions[column_1].width = 5 
     
    # Объединяем ячейки по вертикали если нужно 
    ws.merge_cells(f"{column_1}{row}:{column_1}{row + 8}") 
### 
 
#Вспомогалочка 
period_to_time = { 
    "1": "8:35-  9:20", 
    "2": "9:30-10:15", 
    "3": "10:25-11:10", 
    "4": "11:30-12:15", 
    "5": "12:35-13:20", 
    "6": "13:40-14:25", 
    "7": "14:35-15:20", 
    "8": "15:30-16:15", 
    "9": "16:25-17:10" 
} 
# 
 
#Cкелетик 
 
thin_border = Border( 
    left=Side(style='thin', color='808080'), 
    right=Side(style='thin', color='808080'), 
    top=Side(style='thin', color='808080'), 
    bottom=Side(style='thin', color='808080') 
) 
### 
 
separator_fill = PatternFill(start_color='D3D3D3',  # Светло-серый цвет 
                               end_color='D3D3D3', 
                               fill_type='solid') 
### 
 
time_alignment = Alignment( 
    horizontal='center',     # Выравнивание по горизонтали 
    vertical='center',       # Выравнивание по вертикали 
    wrap_text=True,         # Перенос текста 
    shrink_to_fit=True,     # Уменьшение текста для вмещения 
) 
time_text = Font(color='000000',  
                 size=11, bold = False) 
### 
 
for c in help_class: 
    num = help_class[c] 
    #Название класса 
    column_3 = get_column_letter(5 + 8 * num)  
    row = 1  # Явно указываем строку 
    cell = ws[f"{column_3}{row}"] 
    cell.value = c 
    cell.font = Font(color='000000', size=15, bold=True) 
    cell.alignment = Alignment(horizontal='center', vertical='center') 
    # Объединение ячеек после установки значения 
    ws.merge_cells(f"{column_3}{row}:{get_column_letter(9 + 8 * num)}{row}") 
    # 
 
    #Перегородочки 
     
    ws.column_dimensions[f'{get_column_letter(2 + num * 8)}'].width = 1.7 
    ws.column_dimensions[f'{get_column_letter(4 + num * 8)}'].width = 1.7 
    column_2 = get_column_letter(3 + num * 8)
     
    for row in range(1, 67): 
        cell = ws[f"{column_2}{row}"] 
        cell.fill = separator_fill 
    # Устанавливаем высоту строки перегородки 
    ws.column_dimensions[column_2].width = 0.4 
    ### 
 
    #Время 
    for idx, (day, fill, text, n) in enumerate(help_days_fully.values(), start=1): 
        for i in range(0, 9): 
            column = get_column_letter(5 + num * 8)
 
            cell = ws[f'{column}{2 * (idx - 1) + (idx - 1) * 9 + i + 3}'] 
            cell.value = period_to_time[str(i + 1)] 
            cell.alignment = time_alignment 
            cell.border = thin_border 
            cell.font = time_text 
    ### 
 
    #Уроки
    for idx, (day, fill, text, n) in enumerate(help_days_fully.values(), start=1): 
        for i in range(0, 9): 
            column = get_column_letter(6 + num * 8)
            row = 2 * (idx - 1) + (idx - 1) * 9 + i + 3 
 
            # Сначала записываем значение 
            cell = ws[f'{column}{row}'] 
            cell.value = i+1 
            cell.alignment = time_alignment 
            cell.border = thin_border 
            cell.font = time_text 
            ws.column_dimensions[column].width = 1.8 
    ### 
 
    #Корпуса 
    n_to_b = { 
        "1": "Лицей",  
        "2": "Графский" 
    } 
 
    for _ in classes: 
        if _['name'] == c: 
            for d in _['buildings']: 
                column_4 = get_column_letter(4 + 8 * num) 
                row_4 = 2 + 11 * (help_days_fully[d][3] - 1) 
                cell = ws[f'{column_4}{row_4}'] 
                cell.value = n_to_b[_['buildings'][d]] 
 
                cell.alignment = Alignment( 
                    horizontal='center',     # Выравнивание по горизонтали 
                    vertical='center',       # Выравнивание по вертикали 
                ) 
 
                cell.font = Font(color='000000',  
                    size=13, bold = False, italic=True 
                ) 
 
                ws.merge_cells(f"{column_4}{row_4}:{get_column_letter(9 + 8 * num)}{row_4}")    
    ### 

    #Обязательный РОВ
    
    #Предмет
    row = 4 
    column = get_column_letter(7 + help_class[c] * 8)
    ws.column_dimensions[column].width = 15 
    cell = ws[f'{column}{row}'] 
    cell.value = "РОВ"
    cell.alignment = Alignment( 
                    horizontal='center',     # Выравнивание по горизонтали 
                    vertical='center', 
                    wrap_text=False,        # Отключаем перенос текста 
                    shrink_to_fit=False       # Выравнивание по вертикали 
                ) 
    cell.border = thin_border 
    cell.font = Font(color='FFFFFF', size=11, bold = False)  
    cell.fill = PatternFill(start_color='b00149', fill_type='solid') 
    ### 
 
    #Учитель 
    row = 4
    column = get_column_letter(9 + help_class[c] * 8) 
    ws.column_dimensions[column].width = 15 
    cell = ws[f'{column}{row}'] 
    cell.value = "--"
    cell.alignment = Alignment( 
                    horizontal='center',     # Выравнивание по горизонтали 
                    vertical='center', 
                    wrap_text=True,        # Отключаем перенос текста 
                    shrink_to_fit=False       # Выравнивание по вертикали 
                ) 
    cell.border = thin_border 
    cell.font = Font(color='FFFFFF', size=11, bold = False)  
    cell.fill = PatternFill(start_color='b00149', fill_type='solid') 
    # 
 
    #Кабинеты 
    row = 4
    column = get_column_letter(8 + help_class[c] * 8)
    ws.column_dimensions[column].width = 15 
    cell = ws[f'{column}{row}'] 
    cell.value = "ККЗ"
    cell.alignment = Alignment( 
                    horizontal='center',     # Выравнивание по горизонтали 
                    vertical='center', 
                    wrap_text=False,        # Отключаем перенос текста 
                    shrink_to_fit=False        # Выравнивание по вертикали 
                ) 
    cell.border = thin_border 
    cell.font = Font(color='FFFFFF', size=11, bold = False)  
    cell.fill = PatternFill(start_color='b00149', fill_type='solid') 
    #

 
for prec_p in final_timetable: 

    d = prec_p['День'] 
    p = prec_p['Урок'] 
    c = prec_p['Класс'] 
    t = prec_p['Учитель'] 
    s = prec_p['Предмет'] 
    r = prec_p['Кабинет'] 

    fill = PatternFill(start_color= t_to_color[t.split(",")[0]], fill_type='solid') 
    #Предмет 
    row = 3 + (help_days_fully[d][3] - 1) * 11 + (p - 1) 
    column = get_column_letter(7 + help_class[c] * 8)
    ws.column_dimensions[column].width = 15 
    cell = ws[f'{column}{row}'] 
    cell.value = s 
    cell.alignment = Alignment( 
                    horizontal='center',     # Выравнивание по горизонтали 
                    vertical='center', 
                    wrap_text=False,        # Отключаем перенос текста 
                    shrink_to_fit=False       # Выравнивание по вертикали 
                ) 
    cell.border = thin_border 
    cell.font = time_text 
    cell.fill = fill
    ### 
 
    #Учитель 
    row = 3 + (help_days_fully[d][3] - 1) * 11 + (p - 1) 
    column = get_column_letter(9 + help_class[c] * 8) 
    ws.column_dimensions[column].width = 15 
    cell = ws[f'{column}{row}'] 
    cell.value = t.replace(",", ",\n") 
    cell.alignment = Alignment( 
                    horizontal='center',     # Выравнивание по горизонтали 
                    vertical='center', 
                    wrap_text=True,        # Отключаем перенос текста 
                    shrink_to_fit=False       # Выравнивание по вертикали 
                ) 
    cell.border = thin_border 
    cell.font = time_text 
    cell.fill = fill
    # 
 
    #Кабинеты 
    row = 3 + (help_days_fully[d][3] - 1) * 11 + (p - 1) 
    column = get_column_letter(8 + help_class[c] * 8)
    ws.column_dimensions[column].width = 15 
    cell = ws[f'{column}{row}'] 
    cell.value = r 
    cell.alignment = Alignment( 
                    horizontal='center',     # Выравнивание по горизонтали 
                    vertical='center', 
                    wrap_text=False,        # Отключаем перенос текста 
                    shrink_to_fit=False        # Выравнивание по вертикали 
                ) 
    cell.border = thin_border 
    cell.font = time_text 

wb.save("Итоговое_расписание.xlsx")
# --------------------------------------------
# 8. Вывод окон и переходов в txt
# --------------------------------------------
file_name = "Переходы_и_окна_учителей.txt"
with open(file_name, "w", encoding="UTF-8") as file:
    file.write("**Переходы и окна учитеей по физре см в таблице!! \n")
    file.write("\n")
    file.write("Переходы между корпусами у учителей:\n")
    if txt_output_trans:
        for item in txt_output_trans:

            file.write(f"{item[0]}: {item[1]} - {item[2]} по {item[3]}\n")
    else:
        file.write("Отсутств...\n")

    file.write("\n")

    file.write("Окна у учителей:\n")
    if txt_output_windows:

        for item in txt_output_windows:       
            file.write(f"{item[0]}: {item[1]} - {item[2]} по {item[3]}\n")
    else:
        file.write("Отсутств...\n")
